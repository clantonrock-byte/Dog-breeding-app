<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryMenu')">Inventory</button>
      <button class="btn primary" onclick="__go('Dogs')">Dogs &amp; Pups</button>
      <button class="btn primary" onclick="__go('Feeding')">Feeding</button>
      <button class="btn primary" onclick="__go('Care')">Care Timeline</button>
      <button class="btn primary" onclick="__go('Helpers')">Helpers</button>
      <button class="btn primary" onclick="__go('Records')">Records</button>
    </div>
  </section>

  <!-- INVENTORY MENU -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryAvailable')">Inventory available</button>
      <button class="btn primary" onclick="__go('InventoryAdd')">Add to inventory</button>
      <button class="btn primary" onclick="__go('InventoryAddStock')">Add stock</button>
      <button class="btn primary" onclick="__go('InventoryReduceStock')">Reduce stock</button>
      <button class="btn primary" onclick="__go('InventoryTransfer')">Transfer inventory</button>
    </div>
  </section>

  <!-- INVENTORY AVAILABLE -->
  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>

    <div id="invAvailableMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="invAvailableList"></div>
    <div id="invAvailableArchived" class="hide"></div>
  </section>

  <!-- ADD INVENTORY -->
  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnOpenAddDialog">+ Create item definition</button>
      <button class="btn" onclick="__openScanDialog('add')">Scan now (QR or barcode)</button>
    </div>
  </section>

  <!-- ADD STOCK -->
  <section id="viewInventoryAddStock" class="card hide">
    <h2>Add stock</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row">
      <button class="btn primary" onclick="__openScanDialog('addstock')">Scan item</button>
      <button class="btn" id="btnAddStockRefreshList">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="addStockSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="addStockSelect"></select>

    <div id="addStockForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="addStockItemName"></strong></div>
        <div class="muted small" id="addStockItemMeta"></div>
      </div>

      <label class="label">Quantity to add</label>
      <input id="addStockQty" inputmode="decimal" placeholder="e.g., 10" />

      <label class="label">Note (optional)</label>
      <input id="addStockNote" placeholder="delivery / donation" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnConfirmAddStock">Confirm add</button>
        <button class="btn" onclick="__back()">Cancel</button>
      </div>
    </div>

    <div id="addStockStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- REDUCE STOCK -->
  <section id="viewInventoryReduceStock" class="card hide">
    <h2>Reduce stock</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" onclick="__openScanDialog('reduce')">Scan item</button>
      <button class="btn" id="btnReduceRefreshList">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="reduceSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="reduceSelect"></select>

    <div id="reduceForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="reduceItemName"></strong></div>
        <div class="muted small" id="reduceItemMeta"></div>
      </div>

      <label class="label">Action</label>
      <select id="reduceAction">
        <option>Used</option>
        <option>Discarded</option>
      </select>

      <label class="label">Quantity</label>
      <input id="reduceQty" inputmode="decimal" placeholder="e.g., 1" />

      <label class="label">Note (optional)</label>
      <input id="reduceNote" placeholder="fed / damaged / spoiled" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnConfirmReduce">Confirm</button>
        <button class="btn" onclick="__back()">Cancel</button>
      </div>
    </div>

    <div id="reduceStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- TRANSFER -->
  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row">
      <button class="btn primary" onclick="__openScanDialog('transfer')">Scan item</button>
      <button class="btn" id="btnTransferRefreshList">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="transferSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="transferSelect"></select>

    <div id="transferForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="transferItemName"></strong></div>
        <div class="muted small" id="transferItemMeta"></div>
      </div>

      <label class="label">Quantity to transfer</label>
      <input id="transferQty" inputmode="decimal" placeholder="e.g., 5" />

      <label class="label">Destination</label>
      <select id="transferType">
        <option>With a dog</option>
        <option>To adopter</option>
        <option>To foster</option>
        <option>To another organization</option>
        <option>Moved to storage</option>
        <option>Other</option>
      </select>

      <label class="label">Note (optional)</label>
      <input id="transferNote" placeholder="Any factual notes" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnConfirmTransfer">Confirm transfer</button>
        <button class="btn" onclick="__back()">Cancel</button>
      </div>
    </div>

    <div id="transferStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- OTHER PAGES -->
  <section id="viewDogs" class="card hide"><h2>Dogs &amp; Pups</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewFeeding" class="card hide"><h2>Feeding</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewRecords" class="card hide"><h2>Records</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>

</main>

<!-- ADD DIALOG -->
<dialog id="dlgInv" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Inventory item</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <label class="label">Item name / label</label>
      <input id="invName" />
      <label class="label">Category</label>
      <select id="invCategory">
        <option>Food</option><option>Treat</option><option>Toy</option><option>Blanket</option><option>Equipment</option><option>Other</option>
      </select>
      <label class="label">Source</label>
      <select id="invSource"><option>Purchased</option><option>Donated</option><option>Other</option></select>
      <label class="label">Identifier type</label>
      <select id="invIdType"><option>None</option><option>Barcode</option><option>QR</option></select>
      <label class="label">Identifier value</label>
      <input id="invIdValue" />
      <label class="label">Unit</label>
      <select id="invUnit"><option>count</option><option>weight</option><option>volume</option></select>
      <label class="label">Weight per unit (optional)</label>
      <input id="invWeightPerUnit" />
      <label class="label">Notes (optional)</label>
      <input id="invNotes" />
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="btnSaveInv" value="ok">Save</button>
    </div>
  </form>
</dialog>

<!-- SCAN DIALOG -->
<dialog id="dlgScan" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Scan</h3>
      <button class="info-btn" value="cancel" aria-label="Close" id="btnCloseScan">‚úï</button>
    </div>
    <div class="dlg-b">
      <video id="scanVideo" playsinline autoplay muted></video>
      <div id="scanResultBox" class="scan-result hide">
        <div class="muted small">Identifier captured</div>
        <div id="scanValue" class="scan-value"></div>
      </div>
      <div id="scanHelp" class="muted small"></div>
      <label class="label">Manual entry</label>
      <input id="scanManual" />
    </div>
    <div class="dlg-f">
      <button type="button" class="btn" id="btnRescan">Rescan</button>
      <button type="button" class="btn primary" id="btnConfirmScan">Confirm</button>
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<script src="app.js"></script>

<script>
(function(){
  const INV_STORE_KEY="breederPro_inventory_store_v1";

  function loadStore(){
    try{
      const raw=localStorage.getItem(INV_STORE_KEY);
      if(!raw) return {inventory:[]};
      const obj=JSON.parse(raw);
      if(!obj.inventory) obj.inventory=[];
      return obj;
    }catch{ return {inventory:[]}; }
  }

  // ‚úÖ One-time legacy import if current inventory is empty
  function importLegacyIfEmpty(){
    try{
      const current = loadStore();
      if((current.inventory||[]).length > 0) return;

      let best = null;
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(!key) continue;
        const raw = localStorage.getItem(key);
        if(!raw) continue;
        try{
          const obj = JSON.parse(raw);
          if(obj && Array.isArray(obj.inventory) && obj.inventory.length){
            if(!best || obj.inventory.length > best.inv.length){
              best = { key, inv: obj.inventory };
            }
          }
        }catch(e){}
      }

      if(best){
        localStorage.setItem(INV_STORE_KEY, JSON.stringify({ inventory: best.inv }));
      }
    }catch(e){}
  }

  function getActiveItems(){
    const store=loadStore();
    return (store.inventory||[]).filter(i=>!i.archived);
  }

  function populateSelect(selectId){
    const sel=document.getElementById(selectId);
    if(!sel) return;
    const items=getActiveItems();
    sel.innerHTML="";
    const o0=document.createElement("option"); o0.value=""; o0.textContent="Select item‚Ä¶"; sel.appendChild(o0);
    items.forEach(i=>{
      const opt=document.createElement("option");
      opt.value=i.itemId;
      opt.textContent=`${i.name} (on hand: ${i.qty ?? 0})`;
      sel.appendChild(opt);
    });
  }

  function renderInventoryAvailable(){
    const list=document.getElementById("invAvailableList");
    const active=getActiveItems();
    if(list){
      list.innerHTML = active.length
        ? active.map(i=>`<div class="timeline-item"><strong>${i.name}</strong><div class="muted small">On hand: ${i.qty ?? 0}</div></div>`).join("")
        : `<div class="muted small">No active items.</div>`;
    }
  }

  // Auto-refresh lists when views open (called by app.js)
  window.__afterShow = function(viewName){
    importLegacyIfEmpty();

    if(viewName === "InventoryAddStock"){
      populateSelect("addStockSelect");
    }
    if(viewName === "InventoryReduceStock"){
      populateSelect("reduceSelect");
    }
    if(viewName === "InventoryTransfer"){
      populateSelect("transferSelect");
    }
    if(viewName === "InventoryAvailable"){
      renderInventoryAvailable();
    }
  };

  // Bind refresh buttons too
  document.addEventListener("DOMContentLoaded", ()=>{
    importLegacyIfEmpty();
    renderInventoryAvailable();

    document.getElementById("btnInvRefresh")?.addEventListener("click", renderInventoryAvailable);
    document.getElementById("btnAddStockRefreshList")?.addEventListener("click", ()=> populateSelect("addStockSelect"));
    document.getElementById("btnReduceRefreshList")?.addEventListener("click", ()=> populateSelect("reduceSelect"));
    document.getElementById("btnTransferRefreshList")?.addEventListener("click", ()=> populateSelect("transferSelect"));
  });
})();
</script>

</body>
</html>
