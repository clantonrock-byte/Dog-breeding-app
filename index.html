<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Breeder Pro ‚Äì Rocks Corner</title>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0e0f14;color:#eaeaea;}
  header{padding:12px;background:#12131a;position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,0.08);}
  h1{margin:0;font-size:18px;font-weight:900;}
  .section{padding:12px;}
  .card{background:#161821;border-radius:14px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.08);}
  .row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
  .title{font-size:16px;font-weight:900;margin:0 0 4px 0;}
  .sub{margin:0;font-size:13px;opacity:0.85;}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);opacity:0.95;margin-top:6px;}
  .badge.warn{border-color: rgba(255,59,48,0.55);}
  .badge.ok{border-color: rgba(74,144,226,0.55);}
  button{background:#2f6df6;color:white;border:none;border-radius:10px;padding:10px 14px;font-size:14px;font-weight:800;}
  button.secondary{background:#2a2a2a;}
  button.ghost{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);}
  button:active{transform:translateY(1px);}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}

  .photo-tile{
    width:66px;height:54px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.06);overflow:hidden;display:flex;align-items:center;justify-content:center;
    padding:6px;text-align:center;line-height:1.05;color:rgba(242,242,242,0.9);cursor:pointer;flex:0 0 auto;
  }
  .photo-tile.big{width:100%;height:180px;border-radius:16px;}
  .photo-tile img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block;}
  .photo-tile.big img{border-radius:14px;}
  .photo-tile .cam{font-size:16px;display:block;}
  .photo-tile .txt{font-size:11px;opacity:.9;margin-top:2px;display:block;}

  .divider{height:1px;background:rgba(255,255,255,0.10);margin:14px 0;border-radius:999px;}
  .section-title{font-weight:900;margin:0 0 8px 0;}
  .field{margin-top:10px;}
  .label{font-size:12px;opacity:.8;margin-bottom:6px;}
  input{
    width:100%;box-sizing:border-box;padding:12px;border-radius:12px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.06);
    color:#f2f2f2;font-size:16px;
  }

  #rcToastLite{
    position:fixed;left:12px;right:12px;bottom:18px;z-index:999999;
    display:none;background:rgba(0,0,0,0.78);color:#f2f2f2;
    border:1px solid rgba(255,255,255,0.18);
    border-radius:14px;padding:10px 12px;font-size:14px;
  }
</style>
</head>

<body>
<header><h1>Breeder Pro ‚Äì Rocks Corner</h1></header>

<div id="viewMigration" class="section" style="display:none;"></div>
<div id="viewHome" class="section"></div>
<div id="viewDogs" class="section" style="display:none;"></div>
<div id="viewDogProfile" class="section" style="display:none;"></div>

<div id="rcToastLite"></div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const CLEAN_KEY = "breederPro_dogs_v_clean_v2";
const MIGRATION_DONE = "bp_migration_done_v1";

/* =========================
   UTIL
========================= */
function toast(msg){
  const el=document.getElementById("rcToastLite");
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.style.display="none",1600);
}
function isArchived(status){
  return (status||"").toLowerCase().includes("archived") ||
         (status||"").toLowerCase().includes("deceased");
}

/* =========================
   LOAD LEGACY DOGS (ASSUME BOTH)
========================= */
function findLegacyDogs(){
  const keys = Object.keys(localStorage);
  for(const k of keys){
    try{
      const raw = JSON.parse(localStorage.getItem(k));
      if(Array.isArray(raw) && raw.length && raw[0].callName){
        return { key:k, dogs:raw };
      }
      if(raw && Array.isArray(raw.dogs) && raw.dogs.length){
        return { key:k, dogs:raw.dogs };
      }
    }catch(e){}
  }
  return null;
}

/* =========================
   MIGRATION UI
========================= */
function showMigration(found){
  const el=document.getElementById("viewMigration");
  el.style.display="block";
  document.getElementById("viewHome").style.display="none";

  el.innerHTML=`
    <div class="card">
      <div class="title">Existing dog data found</div>
      <div class="sub">${found.dogs.length} dogs detected from <code>${found.key}</code></div>
      <div class="divider"></div>
      <div class="sub">A backup will be created before migration.</div>
      <div class="btnrow">
        <button onclick="runMigration()">Migrate now</button>
        <button class="ghost" onclick="skipMigration()">Skip for now</button>
      </div>
    </div>
  `;
}

/* =========================
   MIGRATION LOGIC
========================= */
function runMigration(){
  const found=findLegacyDogs();
  if(!found){ skipMigration(); return; }

  const backupKey="bp_backup_dogs_"+Date.now();
  localStorage.setItem(backupKey, JSON.stringify(found));

  const migrated = found.dogs.map(d=>({
    id: d.id || d.dogId || crypto.randomUUID(),
    callName: d.callName || d.name || "Unnamed",
    sex: d.sex || "Unknown",
    status: d.status || "Active",
    photo: d.photo || d.photoDataUrl || null,
    microchips: d.microchips || [],
    rabiesOnFile: !!d.rabiesOnFile
  }));

  localStorage.setItem(CLEAN_KEY, JSON.stringify(migrated));
  localStorage.setItem(MIGRATION_DONE,"true");

  toast("Migration complete");
  setTimeout(()=>location.reload(),800);
}

function skipMigration(){
  localStorage.setItem(MIGRATION_DONE,"true");
  toast("Migration skipped");
  setTimeout(()=>location.reload(),800);
}

/* =========================
   APP STATE
========================= */
let dogs = JSON.parse(localStorage.getItem(CLEAN_KEY)) || [];
let activeDogId=null;

/* =========================
   HOME
========================= */
function renderHome(){
  document.getElementById("viewHome").innerHTML=`
    <div class="card">
      <div class="title">What is our goal today?</div>
      <div class="btnrow">
        <button onclick="goDogs()">Dogs</button>
      </div>
    </div>
  `;
}
function goHome(){
  document.getElementById("viewMigration").style.display="none";
  document.getElementById("viewDogs").style.display="none";
  document.getElementById("viewDogProfile").style.display="none";
  document.getElementById("viewHome").style.display="block";
  renderHome();
}

/* =========================
   DOG LIST
========================= */
function goDogs(){
  document.getElementById("viewHome").style.display="none";
  document.getElementById("viewDogProfile").style.display="none";
  document.getElementById("viewDogs").style.display="block";

  const el=document.getElementById("viewDogs");
  el.innerHTML=`<button class="secondary" onclick="goHome()">‚Üê Back</button>`;

  dogs.forEach(d=>{
    const tile = d.photo
      ? `<img src="${d.photo}">`
      : `<span class="cam">üì∑</span><span class="txt">Profile</span>`;

    const badge = isArchived(d.status)
      ? `<span class="badge warn">${d.status}</span>` : "";

    const card=document.createElement("div");
    card.className="card";
    card.onclick=()=>openProfile(d.id);
    card.innerHTML=`
      <div class="row">
        <div>
          <div class="title">${d.callName}</div>
          <div class="sub">${d.sex} ‚Ä¢ ${d.status}</div>
          ${badge}
        </div>
        <div class="photo-tile">${tile}</div>
      </div>
    `;
    el.appendChild(card);
  });
}

/* =========================
   PROFILE
========================= */
function openProfile(id){
  activeDogId=id;
  const d=dogs.find(x=>x.id===id);
  if(!d) return;

  document.getElementById("viewDogs").style.display="none";
  const el=document.getElementById("viewDogProfile");
  el.style.display="block";

  const tile = d.photo
    ? `<img src="${d.photo}">`
    : `<span class="cam">üì∑</span><span class="txt">${d.callName} ¬∑ Add photo</span>`;

  const badge = isArchived(d.status)
    ? `<span class="badge warn">${d.status}</span>`
    : `<span class="badge ok">${d.status}</span>`;

  el.innerHTML=`
    <button class="secondary" onclick="goDogs()">‚Üê Back</button>
    <div class="card">
      <div class="title">${d.callName}</div>
      <div class="sub">${d.sex} ‚Ä¢ ${d.status}</div>
      ${badge}
      <div class="divider"></div>
      <div class="photo-tile big" onclick="pickPhoto()">${tile}</div>
    </div>
  `;
}

function pickPhoto(){
  const d=dogs.find(x=>x.id===activeDogId);
  if(!d || isArchived(d.status)){ toast("Photo locked"); return; }

  const input=document.createElement("input");
  input.type="file"; input.accept="image/*";
  input.onchange=()=>{
    const file=input.files[0];
    if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      d.photo=r.result;
      localStorage.setItem(CLEAN_KEY, JSON.stringify(dogs));
      openProfile(d.id);
      goDogs();
      toast("Photo saved");
    };
    r.readAsDataURL(file);
  };
  input.click();
}

/* =========================
   INIT
========================= */
(function init(){
  if(!localStorage.getItem(MIGRATION_DONE)){
    const found=findLegacyDogs();
    if(found){ showMigration(found); return; }
    localStorage.setItem(MIGRATION_DONE,"true");
  }
  goHome();
})();
</script>
</body>
</html>
