<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" data-go="Dogs">Dogs &amp; Pups</button>
      <button class="btn primary" data-go="Care">Care Timeline</button>
      <button class="btn primary" data-go="Feeding">Feeding</button>
      <button class="btn primary" data-go="InventoryMenu">Inventory</button>
      <button class="btn primary" data-go="Helpers">Helpers</button>
      <button class="btn primary" data-go="Records">Records &amp; Export</button>
    </div>
  </section>

  <!-- INVENTORY MENU (2nd level) -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>

    <div class="row">
      <button class="btn" data-back="Home">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="goal-grid">
      <button class="btn primary" data-go="InventoryAvailable">Inventory available</button>
      <button class="btn primary" data-go="InventoryAdd">Add to inventory</button>
      <button class="btn primary" data-go="InventoryTransfer">Transfer inventory</button>
    </div>

    <div class="muted small" style="margin-top:12px;">
      This section is designed to stay calm and skimmable.
    </div>
  </section>

  <!-- INVENTORY: AVAILABLE (3rd level) -->
  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>

    <div id="invAvailableMeta" class="muted small" style="margin-top:10px;"></div>

    <div id="invAvailableList"></div>
    <div id="invAvailableArchived" class="hide"></div>
  </section>

  <!-- INVENTORY: ADD -->
  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      Next step: wire this page to open the item-definition form (dropdowns + scan).
    </div>
  </section>

  <!-- INVENTORY: TRANSFER -->
  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      Next step: wire scan ‚Üí match ‚Üí transfer update (destination + contact).
    </div>
  </section>

  <!-- OTHER MODULE PLACEHOLDERS -->
  <section id="viewDogs" class="card hide"><h2>Dogs &amp; Pups</h2></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2></section>
  <section id="viewFeeding" class="card hide"><h2>Feeding</h2></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2></section>
  <section id="viewRecords" class="card hide"><h2>Records &amp; Export</h2></section>

</main>

<button id="btnEmergency" class="btn danger emergency-fixed">Emergency</button>

<script>
(function(){
  const VIEWS = [
    "Home",
    "InventoryMenu",
    "InventoryAvailable",
    "InventoryAdd",
    "InventoryTransfer",
    "Dogs","Care","Feeding","Helpers","Records"
  ];

  function showView(name){
    VIEWS.forEach(v=>{
      const el = document.getElementById("view" + v);
      if(el) el.classList.toggle("hide", v !== name);
    });

    // Auto-render inventory when opening InventoryAvailable
    if(name === "InventoryAvailable"){
      renderInventoryAvailable();
    }
  }

  function bindNav(){
    document.querySelectorAll("[data-go]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView(btn.dataset.go));
    });
    document.querySelectorAll("[data-back]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView(btn.dataset.back));
    });
    document.querySelectorAll("[data-home]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView("Home"));
    });
  }

  // ---- Inventory detection + rendering (read-only) ----

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function inventoryLow(it){
    const t = it.thresholdLow;
    if(t === null || t === undefined || t === "") return false;
    return Number(it.qty) <= Number(t);
  }

  // Finds the most likely inventory store in localStorage (no risk, just read)
  function findInventoryStore(){
    let best = null;

    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      if(!key) continue;

      const raw = localStorage.getItem(key);
      if(!raw || raw.length < 5) continue;

      try{
        const obj = JSON.parse(raw);
        if(obj && Array.isArray(obj.inventory)){
          const score = obj.inventory.length + raw.length/10000;
          if(!best || score > best.score){
            best = { key, score, obj };
          }
        }
      }catch(e){}
    }

    return best; // {key, obj}
  }

  function renderInventoryAvailable(){
    const meta = document.getElementById("invAvailableMeta");
    const list = document.getElementById("invAvailableList");
    const arch = document.getElementById("invAvailableArchived");
    if(!meta || !list || !arch) return;

    const store = findInventoryStore();
    if(!store){
      meta.textContent = "No saved inventory found yet.";
      list.innerHTML = `<div class="muted small">No inventory items recorded yet.</div>`;
      arch.innerHTML = "";
      return;
    }

    const inv = store.obj.inventory || [];
    const active = inv.filter(i=>!i.archived);
    const archived = inv.filter(i=>i.archived);

    meta.textContent = `Source: local saved inventory (${store.key}). Active: ${active.length}. Archived: ${archived.length}.`;

    if(!active.length){
      list.innerHTML = `<div class="muted small">No active inventory items recorded.</div>`;
    } else {
      list.innerHTML = active.map(i=>{
        const low = inventoryLow(i);
        const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
        const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;

        const idLine = (i.identifierType && i.identifierType !== "None")
          ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
          : "Identifier: none";

        return `
          <div class="inv-item">
            <div class="inv-top">
              <div>
                <div class="inv-name ${low ? "low" : ""}">${escapeHtml(i.name||"(unnamed)")}</div>
                <div class="inv-meta">${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
                <div class="inv-meta">${idLine}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    if(!archived.length){
      arch.innerHTML = `<div class="muted small">No archived inventory items.</div>`;
    } else {
      arch.innerHTML = archived.map(i=>{
        const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
        const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;
        const idLine = (i.identifierType && i.identifierType !== "None")
          ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
          : "Identifier: none";

        return `
          <div class="inv-item">
            <div class="inv-top">
              <div>
                <div class="inv-name">${escapeHtml(i.name||"(unnamed)")}</div>
                <div class="inv-meta">Archived ‚Ä¢ ${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
                <div class="inv-meta">${idLine}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }
  }

  function bindInventoryAvailableButtons(){
    const refresh = document.getElementById("btnInvRefresh");
    const toggle = document.getElementById("btnInvToggleArchived");
    const arch = document.getElementById("invAvailableArchived");

    if(refresh) refresh.addEventListener("click", renderInventoryAvailable);

    if(toggle && arch){
      toggle.addEventListener("click", ()=>{
        arch.classList.toggle("hide");
      });
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    bindNav();
    bindInventoryAvailableButtons();
    showView("Home");
  });
})();
</script>

</body>
</html>
