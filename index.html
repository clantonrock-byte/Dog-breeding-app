<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" data-go="Dogs">Dogs &amp; Pups</button>
      <button class="btn primary" data-go="Care">Care Timeline</button>
      <button class="btn primary" data-go="Feeding">Feeding</button>
      <button class="btn primary" data-go="InventoryMenu">Inventory</button>
      <button class="btn primary" data-go="Helpers">Helpers</button>
      <button class="btn primary" data-go="Records">Records &amp; Export</button>
    </div>
  </section>

  <!-- INVENTORY MENU (2nd level) -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>

    <div class="row">
      <button class="btn" data-back="Home">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="goal-grid">
      <button class="btn primary" data-go="InventoryAvailable">Inventory available</button>
      <button class="btn primary" data-go="InventoryAdd">Add to inventory</button>
      <button class="btn primary" data-go="InventoryTransfer">Transfer inventory</button>
    </div>
  </section>

  <!-- INVENTORY: AVAILABLE (3rd level) -->
  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>

    <div id="invAvailableMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="invAvailableList"></div>
    <div id="invAvailableArchived" class="hide"></div>
  </section>

  <!-- INVENTORY: ADD -->
  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin:10px 0;">
      This records item definition (what it is). Stock changes happen through Transfer and future Add-stock tools.
    </div>

    <button class="btn primary" id="btnOpenAddDialog">+ Create item definition</button>

    <div class="muted small" style="margin-top:12px;">
      After saving, the item will appear under ‚ÄúInventory available‚Äù.
    </div>
  </section>

  <!-- INVENTORY: TRANSFER -->
  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin:10px 0;">
      Scan an identifier or select an item, then record transfer destination and quantity.
    </div>

    <div class="row">
      <!-- Extra redundancy: onclick opens scan dialog even if wiring ever fails -->
      <button class="btn primary" id="btnTransferScan" onclick="window.__openScanDialog && window.__openScanDialog()">Scan item</button>
      <button class="btn" id="btnTransferRefreshList">Refresh list</button>
    </div>

    <label class="label">Or select an item (manual)</label>
    <select id="transferSelect"></select>

    <div id="transferForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="transferItemName"></strong></div>
        <div class="muted small" id="transferItemMeta"></div>
      </div>

      <label class="label">Quantity to transfer</label>
      <input id="transferQty" inputmode="decimal" placeholder="e.g., 5" />

      <label class="label">Transfer destination</label>
      <select id="transferType">
        <option>With a dog</option>
        <option>To adopter</option>
        <option>To foster</option>
        <option>To another organization</option>
        <option>Returned to donor</option>
        <option>Moved to storage</option>
        <option>Other</option>
      </select>

      <label class="label">Destination details (optional)</label>
      <input id="transferDetail" placeholder="e.g., Dog name / org name / storage location" />

      <label class="label">Contact person (optional)</label>
      <input id="transferContactPerson" placeholder="e.g., Jordan Smith" />

      <label class="label">Contact method (optional)</label>
      <select id="transferContactMethod">
        <option>None</option>
        <option>Phone</option>
        <option>Email</option>
        <option>Both</option>
        <option>Other</option>
      </select>

      <label class="label">Contact details (optional)</label>
      <input id="transferContactDetails" placeholder="e.g., 555-555-5555 / name@email.com" />

      <label class="label">Note (optional)</label>
      <input id="transferNote" placeholder="Any factual notes" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnConfirmTransfer">Confirm transfer</button>
        <button class="btn" id="btnCancelTransfer">Cancel</button>
      </div>
    </div>

    <div id="transferStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- PLACEHOLDERS (later) -->
  <section id="viewDogs" class="card hide"><h2>Dogs &amp; Pups</h2></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2></section>
  <section id="viewFeeding" class="card hide"><h2>Feeding</h2></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2></section>
  <section id="viewRecords" class="card hide"><h2>Records &amp; Export</h2></section>

</main>

<button id="btnEmergency" class="btn danger emergency-fixed">Emergency</button>

<!-- ‚úÖ Add Definition Dialog -->
<dialog id="dlgInv" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Inventory item</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>

    <div class="dlg-b">
      <label class="label">Item name / label</label>
      <input id="invName" />

      <div class="grid2">
        <div>
          <label class="label">Category</label>
          <select id="invCategory">
            <option>Food</option><option>Treat</option><option>Topper</option><option>Supplement</option>
            <option>Toy</option><option>Blanket</option><option>Coat</option><option>Equipment</option><option>Other</option>
          </select>
        </div>
        <div>
          <label class="label">Source</label>
          <select id="invSource">
            <option>Purchased</option><option>Donated</option><option>Other</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label class="label">Identifier type</label>
          <select id="invIdType"><option>None</option><option>Barcode</option><option>QR</option></select>
        </div>
        <div>
          <label class="label">Identifier value</label>
          <input id="invIdValue" placeholder="(scan or type)" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label class="label">Unit</label>
          <select id="invUnit"><option>count</option><option>weight</option><option>volume</option></select>
        </div>
        <div>
          <label class="label">Weight per unit (optional)</label>
          <input id="invWeightPerUnit" placeholder="e.g., 40 lb" />
        </div>
      </div>

      <label class="label">Notes (optional)</label>
      <input id="invNotes" />
    </div>

    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="btnSaveInv" value="ok">Save</button>
    </div>
  </form>
</dialog>

<!-- ‚úÖ Scan Dialog (Confirm required + manual fallback) -->
<dialog id="dlgScan" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Scan</h3>
      <button class="info-btn" value="cancel" aria-label="Close" id="btnCloseScan">‚úï</button>
    </div>

    <div class="dlg-b">
      <video id="scanVideo" playsinline></video>

      <div id="scanResultBox" class="scan-result hide">
        <div class="muted small">Identifier captured</div>
        <div id="scanValue" class="scan-value"></div>
      </div>

      <div id="scanHelp" class="muted small" style="margin-top:10px;"></div>

      <!-- Manual fallback -->
      <label class="label" style="margin-top:12px;">Manual entry (if needed)</label>
      <input id="scanManual" placeholder="Type or paste barcode here" inputmode="numeric" />
    </div>

    <div class="dlg-f">
      <button type="button" class="btn" id="btnRescan">Rescan</button>
      <button type="button" class="btn primary" id="btnConfirmScan">Confirm</button>
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  // ----- Views -----
  const VIEWS = ["Home","InventoryMenu","InventoryAvailable","InventoryAdd","InventoryTransfer","Dogs","Care","Feeding","Helpers","Records"];
  function showView(name){
    VIEWS.forEach(v=>{
      const el = document.getElementById("view"+v);
      if(el) el.classList.toggle("hide", v !== name);
    });
    if(name === "InventoryAvailable") renderInventoryAvailable();
    if(name === "InventoryTransfer") populateTransferSelect();
  }

  // ----- Store -----
  const INV_STORE_KEY = "breederPro_inventory_store_v1";
  function loadStore(){
    try{
      const raw = localStorage.getItem(INV_STORE_KEY);
      if(!raw) return { inventory: [] };
      const obj = JSON.parse(raw);
      if(!obj.inventory) obj.inventory = [];
      return obj;
    }catch{ return { inventory: [] }; }
  }
  function saveStore(obj){ localStorage.setItem(INV_STORE_KEY, JSON.stringify(obj)); }

  // ----- Rendering: Available -----
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function inventoryLow(it){
    const t = it.thresholdLow;
    if(t === null || t === undefined || t === "") return false;
    return Number(it.qty) <= Number(t);
  }
  function renderInventoryAvailable(){
    const meta = document.getElementById("invAvailableMeta");
    const list = document.getElementById("invAvailableList");
    const arch = document.getElementById("invAvailableArchived");

    const store = loadStore();
    const inv = store.inventory || [];
    const active = inv.filter(i=>!i.archived);
    const archived = inv.filter(i=>i.archived);

    meta.textContent = `Source: local inventory (v1). Active: ${active.length}. Archived: ${archived.length}.`;

    list.innerHTML = active.length ? active.map(i=>{
      const low = inventoryLow(i);
      const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
      const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;
      const idLine = (i.identifierType && i.identifierType !== "None")
        ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
        : "Identifier: none";

      return `
        <div class="inv-item">
          <div class="inv-top">
            <div>
              <div class="inv-name ${low ? "low" : ""}">${escapeHtml(i.name||"(unnamed)")}</div>
              <div class="inv-meta">${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
              <div class="inv-meta">${idLine}</div>
            </div>
          </div>
        </div>
      `;
    }).join("") : `<div class="muted small">No active inventory items recorded.</div>`;

    arch.innerHTML = archived.length ? archived.map(i=>{
      const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
      const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;
      const idLine = (i.identifierType && i.identifierType !== "None")
        ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
        : "Identifier: none";

      return `
        <div class="inv-item">
          <div class="inv-top">
            <div>
              <div class="inv-name">${escapeHtml(i.name||"(unnamed)")}</div>
              <div class="inv-meta">Archived ‚Ä¢ ${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
              <div class="inv-meta">${idLine}</div>
            </div>
          </div>
        </div>
      `;
    }).join("") : `<div class="muted small">No archived inventory items.</div>`;
  }

  // ----- Add definition -----
  function openAddDialog(){
    document.getElementById("invName").value = "";
    document.getElementById("invCategory").value = "Food";
    document.getElementById("invSource").value = "Other";
    document.getElementById("invIdType").value = "None";
    document.getElementById("invIdValue").value = "";
    document.getElementById("invUnit").value = "count";
    document.getElementById("invWeightPerUnit").value = "";
    document.getElementById("invNotes").value = "";
    document.getElementById("dlgInv").showModal();
  }

  function saveDefinition(){
    const name = (document.getElementById("invName").value || "").trim();
    if(!name){ alert("Item name is required."); return; }

    const store = loadStore();
    store.inventory.push({
      itemId: "inv_" + Date.now(),
      name,
      category: document.getElementById("invCategory").value,
      source: document.getElementById("invSource").value,
      identifierType: document.getElementById("invIdType").value,
      identifierValue: (document.getElementById("invIdValue").value || "").trim(),
      unit: document.getElementById("invUnit").value,
      weightPerUnit: (document.getElementById("invWeightPerUnit").value || "").trim(),
      notes: (document.getElementById("invNotes").value || "").trim(),
      qty: 0,
      thresholdLow: null,
      archived: false,
      createdAt: new Date().toISOString(),
      history: []
    });

    saveStore(store);
    document.getElementById("dlgInv").close();
    showView("InventoryAvailable");
    renderInventoryAvailable();
  }

  // ----- Transfer -----
  let transferItemId = null;

  function populateTransferSelect(){
    const sel = document.getElementById("transferSelect");
    if(!sel) return;

    const store = loadStore();
    const active = (store.inventory||[]).filter(i=>!i.archived);

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select item‚Ä¶";
    sel.appendChild(opt0);

    active.forEach(i=>{
      const opt = document.createElement("option");
      opt.value = i.itemId;
      opt.textContent = `${i.name} (on hand: ${i.qty ?? 0})`;
      sel.appendChild(opt);
    });
  }

  function showTransferForm(itemId){
    const store = loadStore();
    const it = (store.inventory||[]).find(x=>x.itemId === itemId);
    if(!it){
      document.getElementById("transferStatus").textContent = "Item not found.";
      return;
    }
    transferItemId = itemId;

    document.getElementById("transferForm").classList.remove("hide");
    document.getElementById("transferItemName").textContent = it.name;

    const idLine = (it.identifierType && it.identifierType !== "None") ? `${it.identifierType}: ${it.identifierValue}` : "Identifier: none";
    document.getElementById("transferItemMeta").textContent =
      `${it.category} ‚Ä¢ ${it.source} ‚Ä¢ ${it.unit} ‚Ä¢ On hand: ${it.qty ?? 0} ‚Ä¢ ${idLine}`;

    document.getElementById("transferQty").value = "1";
    document.getElementById("transferType").value = "With a dog";
    document.getElementById("transferDetail").value = "";
    document.getElementById("transferContactPerson").value = "";
    document.getElementById("transferContactMethod").value = "None";
    document.getElementById("transferContactDetails").value = "";
    document.getElementById("transferNote").value = "";
    document.getElementById("transferStatus").textContent = "";
  }

  function applyTransfer(){
    const store = loadStore();
    const inv = store.inventory || [];
    const it = inv.find(x=>x.itemId === transferItemId);
    if(!it){ document.getElementById("transferStatus").textContent = "Item not found."; return; }

    const qty = Math.abs(Number(document.getElementById("transferQty").value || "0") || 0);
    if(qty <= 0){ document.getElementById("transferStatus").textContent = "Quantity needs to be greater than 0."; return; }

    const before = Number(it.qty || 0);
    const after = Math.max(0, before - qty);
    it.qty = after;

    const transfer = {
      destinationType: document.getElementById("transferType").value,
      destinationDetail: (document.getElementById("transferDetail").value||"").trim(),
      contactPerson: (document.getElementById("transferContactPerson").value||"").trim(),
      contactMethod: document.getElementById("transferContactMethod").value,
      contactDetails: (document.getElementById("transferContactDetails").value||"").trim()
    };
    const note = (document.getElementById("transferNote").value||"").trim();

    it.history = it.history || [];
    it.history.push({
      ts: new Date().toISOString(),
      action: "Transferred",
      qtyDelta: -qty,
      note,
      transfer
    });

    saveStore(store);
    document.getElementById("transferStatus").textContent = "Transfer recorded.";
    renderInventoryAvailable();
    populateTransferSelect();
  }

  function cancelTransfer(){
    transferItemId = null;
    document.getElementById("transferForm").classList.add("hide");
    document.getElementById("transferStatus").textContent = "";
  }

  // ----- Scan (Confirm required + manual fallback) -----
  let scanStream = null;
  let lastScanValue = "";

  async function startScan(){
    const video = document.getElementById("scanVideo");
    const help = document.getElementById("scanHelp");
    const box = document.getElementById("scanResultBox");
    const val = document.getElementById("scanValue");

    lastScanValue = "";
    box.classList.add("hide");
    val.textContent = "";
    help.textContent = "";

    try{
      scanStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
      video.srcObject = scanStream;
      await video.play();
    }catch{
      help.textContent = "Camera access unavailable. Manual entry remains available.";
      return;
    }

    if(!("BarcodeDetector" in window)){
      help.textContent = "Scanner not supported on this browser. Manual entry remains available.";
      return;
    }

    let detector;
    try{ detector = new BarcodeDetector({ formats:["qr_code","code_128","ean_13","ean_8","upc_a","upc_e"] }); }
    catch{ detector = new BarcodeDetector(); }

    help.textContent = "Point camera at code. Confirm is required after a scan.";

    const loop = async ()=>{
      if(!scanStream) return;
      try{
        const codes = await detector.detect(video);
        if(codes && codes.length){
          const raw = codes[0].rawValue || "";
          if(raw){
            lastScanValue = raw;
            box.classList.remove("hide");
            val.textContent = raw;
            stopScanStream();
            return;
          }
        }
      }catch{}
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  function stopScanStream(){
    const video = document.getElementById("scanVideo");
    if(video) video.pause();
    if(scanStream){
      scanStream.getTracks().forEach(t=>t.stop());
      scanStream = null;
    }
  }

  function openScanDialog(){
    // clear manual field each time
    document.getElementById("scanManual").value = "";
    document.getElementById("dlgScan").showModal();
    startScan();
  }
  function closeScanDialog(){
    stopScanStream();
    document.getElementById("dlgScan").close();
  }

  function confirmScan(){
    const manual = (document.getElementById("scanManual")?.value || "").trim();
    const code = (lastScanValue && lastScanValue.trim()) ? lastScanValue.trim() : manual;

    if(!code){
      document.getElementById("scanHelp").textContent = "No identifier captured. Manual entry is available.";
      return;
    }

    const store = loadStore();
    const inv = store.inventory || [];

    const match = inv.find(i =>
      (i.identifierType === "Barcode" || i.identifierType === "QR") &&
      String(i.identifierValue||"").trim() === code
    );

    closeScanDialog();

    if(!match){
      document.getElementById("transferStatus").textContent =
        "No matching item found for this identifier. Create the item definition first.";
      return;
    }

    showTransferForm(match.itemId);
  }

  // expose openScanDialog for button redundancy
  window.__openScanDialog = openScanDialog;

  // ----- bindings -----
  document.addEventListener("DOMContentLoaded", ()=>{
    bindNav();
    renderInventoryAvailable();

    // Available page
    document.getElementById("btnInvRefresh")?.addEventListener("click", renderInventoryAvailable);
    document.getElementById("btnInvToggleArchived")?.addEventListener("click", ()=>{
      document.getElementById("invAvailableArchived")?.classList.toggle("hide");
    });

    // Add page
    document.getElementById("btnOpenAddDialog")?.addEventListener("click", openAddDialog);
    document.getElementById("btnSaveInv")?.addEventListener("click", (e)=>{ e.preventDefault(); saveDefinition(); });

    // Transfer page
    document.getElementById("btnTransferRefreshList")?.addEventListener("click", populateTransferSelect);
    document.getElementById("transferSelect")?.addEventListener("change", (e)=>{ if(e.target.value) showTransferForm(e.target.value); });
    document.getElementById("btnConfirmTransfer")?.addEventListener("click", applyTransfer);
    document.getElementById("btnCancelTransfer")?.addEventListener("click", cancelTransfer);

    document.getElementById("btnTransferScan")?.addEventListener("click", openScanDialog);

    // Scan dialog
    document.getElementById("btnRescan")?.addEventListener("click", startScan);
    document.getElementById("btnConfirmScan")?.addEventListener("click", confirmScan);
    document.getElementById("btnCloseScan")?.addEventListener("click", closeScanDialog);
    document.getElementById("dlgScan")?.addEventListener("close", stopScanStream);

    // Voice
    document.getElementById("btnTalk")?.addEventListener("click", ()=> alert("Voice may be used at any time."));

    showView("Home");
  });
})();
</script>

</body>
        </html>
