<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Breeder Pro ‚Äì Rocks Corner</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0e0f14;color:#eaeaea;}
  header{padding:12px;background:#12131a;position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,0.08);}
  h1{margin:0;font-size:18px;font-weight:900;}
  .section{padding:12px;}
  .card{background:#161821;border-radius:14px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.08);}
  .row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
  .title{font-size:16px;font-weight:900;margin:0 0 4px 0;}
  .sub{margin:0;font-size:13px;opacity:0.85;}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);opacity:0.95;margin-top:6px;}
  .badge.warn{border-color: rgba(255,59,48,0.55);}
  .badge.ok{border-color: rgba(74,144,226,0.55);}
  button{background:#2f6df6;color:white;border:none;border-radius:10px;padding:10px 14px;font-size:14px;font-weight:800;}
  button.secondary{background:#2a2a2a;}
  button.ghost{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);}
  button:active{transform:translateY(1px);}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
  .photo-tile{
    width:66px;height:54px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.06);overflow:hidden;display:flex;align-items:center;justify-content:center;
    padding:6px;text-align:center;line-height:1.05;color:rgba(242,242,242,0.9);cursor:pointer;flex:0 0 auto;
  }
  .photo-tile.big{width:100%;height:180px;border-radius:16px;}
  .photo-tile img{width:100%;height:100%;object-fit:cover;border-radius:10px;display:block;}
  .photo-tile.big img{border-radius:14px;}
  .photo-tile .cam{font-size:16px;display:block;}
  .photo-tile .txt{font-size:11px;opacity:.9;margin-top:2px;display:block;}
  .divider{height:1px;background:rgba(255,255,255,0.10);margin:14px 0;border-radius:999px;}
  .field{margin-top:10px;}
  .label{font-size:12px;opacity:.8;margin-bottom:6px;}
  input{
    width:100%;box-sizing:border-box;padding:12px;border-radius:12px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.06);
    color:#f2f2f2;font-size:16px;
  }
  code{background:rgba(0,0,0,0.35);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);}
  #rcToastLite{
    position:fixed;left:12px;right:12px;bottom:18px;z-index:999999;
    display:none;background:rgba(0,0,0,0.78);color:#f2f2f2;border:1px solid rgba(255,255,255,0.18);
    border-radius:14px;padding:10px 12px;font-size:14px;
  }
</style>
</head>
<body>
<header><h1>Breeder Pro ‚Äì Rocks Corner</h1></header>

<div id="viewMigration" class="section" style="display:none;"></div>
<div id="viewHome" class="section"></div>
<div id="viewDogs" class="section" style="display:none;"></div>
<div id="viewDogProfile" class="section" style="display:none;"></div>
<div id="viewInventory" class="section" style="display:none;"></div>
<div id="viewStock" class="section" style="display:none;"></div>
<div id="viewScanner" class="section" style="display:none;"></div>

<div id="rcToastLite"></div>

<script>
const CLEAN_KEY="breederPro_dogs_v_clean_v2";
const MIGRATION_DONE="bp_migration_done_v1";
const INV_KEY="bp_inventory_v1";
const STOCK_KEY="bp_stock_v1";

function toast(msg){
  const el=document.getElementById("rcToastLite");
  el.textContent=String(msg||"");
  el.style.display="block";
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.style.display="none",1600);
}
function isArchived(status){
  const s=(status||"").toLowerCase();
  return s.includes("archived") || s.includes("deceased");
}

function findLegacyDogs(){
  const keys=Object.keys(localStorage);
  for(const k of keys){
    try{
      const raw=JSON.parse(localStorage.getItem(k));
      if(Array.isArray(raw) && raw.length) return {key:k, dogs:raw};
      if(raw && Array.isArray(raw.dogs) && raw.dogs.length) return {key:k, dogs:raw.dogs};
    }catch(e){}
  }
  return null;
}

function showMigration(found){
  const el=document.getElementById("viewMigration");
  el.style.display="block";
  document.getElementById("viewHome").style.display="none";
  el.innerHTML=`
    <div class="card">
      <div class="title">Existing data found</div>
      <div class="sub">${found.dogs.length} records detected from <code>${found.key}</code></div>
      <div class="divider"></div>
      <div class="sub">A backup will be created before migration.</div>
      <div class="btnrow">
        <button onclick="runMigration()">Migrate now</button>
        <button class="ghost" onclick="skipMigration()">Skip for now</button>
      </div>
    </div>
  `;
}

function runMigration(){
  const found=findLegacyDogs();
  if(!found){ skipMigration(); return; }
  localStorage.setItem("bp_backup_dogs_"+Date.now(), JSON.stringify(found));

  const migrated = found.dogs.map(d=>({
    id: d.id || d.dogId || crypto.randomUUID(),
    callName: d.callName || d.name || "Unnamed",
    sex: d.sex || "Unknown",
    status: d.status || "Active",
    photo: d.photo || d.photoDataUrl || null,
    microchips: Array.isArray(d.microchips)?d.microchips:[],
    rabiesOnFile: !!d.rabiesOnFile
  }));

  localStorage.setItem(CLEAN_KEY, JSON.stringify(migrated));
  localStorage.setItem(MIGRATION_DONE,"true");
  toast("Migration complete");
  setTimeout(()=>location.reload(), 600);
}
function skipMigration(){
  localStorage.setItem(MIGRATION_DONE,"true");
  toast("Migration skipped");
  setTimeout(()=>location.reload(), 600);
}

let dogs = JSON.parse(localStorage.getItem(CLEAN_KEY)) || [];
let activeDogId=null;
let inventory = JSON.parse(localStorage.getItem(INV_KEY)) || [];
let stock = JSON.parse(localStorage.getItem(STOCK_KEY)) || [];
let scannerMode = "inventory"; // inventory|stock
let scannerAction = "add"; // add|reduce

function saveDogs(){ localStorage.setItem(CLEAN_KEY, JSON.stringify(dogs)); }
function saveInventory(){ localStorage.setItem(INV_KEY, JSON.stringify(inventory)); }
function saveStock(){ localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); }

function showOnly(id){
  ["viewMigration","viewHome","viewDogs","viewDogProfile","viewInventory","viewStock","viewScanner"].forEach(v=>{
    document.getElementById(v).style.display = (v===id) ? "block" : "none";
  });
}

function goHome(){
  showOnly("viewHome");
  document.getElementById("viewHome").innerHTML=`
    <div class="card">
      <div class="title">What is our goal today?</div>
      <div class="btnrow">
        <button onclick="goDogs()">Dogs</button>
        <button onclick="goInventory()">Inventory (Edible)</button>
        <button onclick="goStock()">Stock (Inedible)</button>
        <button onclick="goScanner()">Scanner</button>
      </div>
    </div>
  `;
}

function goDogs(){
  showOnly("viewDogs");
  const el=document.getElementById("viewDogs");
  el.innerHTML=`<button class="secondary" onclick="goHome()">‚Üê Back</button>`;
  dogs.forEach(d=>{
    const tile=d.photo?`<img src="${d.photo}">`:`<span class="cam">üì∑</span><span class="txt">Profile</span>`;
    const badge=isArchived(d.status)?`<span class="badge warn">${d.status}</span>`:"";
    const card=document.createElement("div");
    card.className="card";
    card.onclick=()=>openProfile(d.id);
    card.innerHTML=`
      <div class="row">
        <div>
          <div class="title">${d.callName}</div>
          <div class="sub">${d.sex} ‚Ä¢ ${d.status}</div>
          ${badge}
        </div>
        <div class="photo-tile">${tile}</div>
      </div>
    `;
    el.appendChild(card);
  });
}

function openProfile(id){
  activeDogId=id;
  const d=dogs.find(x=>x.id===id);
  if(!d) return;
  showOnly("viewDogProfile");

  const badge=isArchived(d.status)?`<span class="badge warn">${d.status}</span>`:`<span class="badge ok">${d.status}</span>`;
  const tile=d.photo?`<img src="${d.photo}">`:`<span class="cam">üì∑</span><span class="txt">${d.callName} ¬∑ Add photo</span>`;
  document.getElementById("viewDogProfile").innerHTML=`
    <button class="secondary" onclick="goDogs()">‚Üê Back</button>
    <div class="card">
      <div class="title">${d.callName}</div>
      <div class="sub">${d.sex} ‚Ä¢ ${d.status}</div>
      ${badge}
      <div class="divider"></div>
      <div class="photo-tile big" onclick="pickPhoto()">${tile}</div>
    </div>
  `;
}

function pickPhoto(){
  const d=dogs.find(x=>x.id===activeDogId);
  if(!d) return;
  if(isArchived(d.status)){ toast("Photo locked"); return; }
  const input=document.createElement("input");
  input.type="file"; input.accept="image/*";
  input.onchange=()=>{
    const file=input.files[0];
    if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      d.photo=r.result;
      saveDogs();
      toast("Photo saved");
      openProfile(d.id);
    };
    r.readAsDataURL(file);
  };
  input.click();
}

/* ===== Inventory ===== */
function goInventory(){
  showOnly("viewInventory");
  renderInventory(false);
}

function goStock(){
  showOnly("viewStock");
  renderStock(false);
}

function goScanner(){
  showOnly("viewScanner");
  renderScanner();
}


function renderScanner(){
  const el=document.getElementById("viewScanner");
  const lastMode = localStorage.getItem("scan_last_mode") || "quick"; // quick|reconcile
  const lastQty = Number(localStorage.getItem("scan_last_qty") || 1);
  const modeLabel = (scannerMode==="inventory") ? "Inventory (Edible)" : "Stock (Inedible)";

  el.innerHTML=`
    <button class="secondary" onclick="${scannerMode==='inventory' ? 'goInventory()' : 'goStock()'}">‚Üê Back</button>
    <div class="card">
      <div class="title">Scanner</div>
      <div class="sub">Target: <b>${modeLabel}</b></div>

      <div class="btnrow">
        <button class="ghost" onclick="setScanMode('inventory')">Inventory</button>
        <button class="ghost" onclick="setScanMode('stock')">Stock</button>
      </div>

      <div class="divider"></div>

      <div class="btnrow">
        <button class="ghost" onclick="setScanFlow('quick')">Quick</button>
        <button class="ghost" onclick="setScanFlow('reconcile')">Reconcile</button>
      </div>

      <div class="divider"></div>

      <div class="field">
        <div class="label">Barcode</div>
        <input id="scanCode" inputmode="numeric" autocomplete="off" placeholder="Scan or type barcode"/>
      </div>

      <div id="quickBlock">
        <div class="field">
          <div class="label">Quantity</div>
          <input id="scanQty" type="number" min="0" step="1" value="${lastQty}"/>
        </div>
        <div class="btnrow">
          <button class="ghost" onclick="setQty(1)">+1</button>
          <button class="ghost" onclick="setQty(10)">+10</button>
          <button class="ghost" onclick="setQty(25)">+25</button>
          <button class="ghost" onclick="setQty(32)">+32</button>
          <button class="ghost" onclick="setQty(50)">+50</button>
        </div>
      </div>

      <div id="reconBlock" style="display:none;">
        <div class="field">
          <div class="label">Planned</div>
          <input id="scanPlanned" type="number" min="0" step="1" value="${lastQty}"/>
        </div>
        <div class="field">
          <div class="label">Counted</div>
          <input id="scanCounted" type="number" min="0" step="1" value="${lastQty}"/>
        </div>
        <div class="sub muted">Only <b>Counted</b> will be applied.</div>
      </div>

      <div class="divider"></div>

      <div class="btnrow" style="justify-content:flex-end;">
        <button onclick="scanApply()">Apply</button>
      </div>
    </div>
  `;

  setScanFlow(lastMode);
}


function setScanMode(m){
  scannerMode = (m==="stock") ? "stock" : "inventory";
  toast("Scanner mode: " + (scannerMode==="inventory" ? "Inventory" : "Stock"));
  renderScanner();
}


function setScanFlow(flow){
  localStorage.setItem("scan_last_mode", flow);
  const q=document.getElementById("quickBlock");
  const r=document.getElementById("reconBlock");
  if(q && r){
    q.style.display = (flow==="quick") ? "block" : "none";
    r.style.display = (flow==="reconcile") ? "block" : "none";
  }
  toast("Scanner mode: " + (flow==="quick" ? "Quick" : "Reconcile"));
}
function setQty(v){
  const el=document.getElementById("scanQty");
  if(el){ el.value = v; localStorage.setItem("scan_last_qty", v); }
}

function setScanAction(a){
  scannerAction = (a==="reduce") ? "reduce" : "add";
  toast("Scanner action: " + (scannerAction==="add" ? "Add +1" : "Reduce -1"));
  renderScanner();
}


function scanApply(){
  const code=(document.getElementById("scanCode").value||"").trim();
  if(!code){ toast("Enter barcode"); return; }

  const flow = localStorage.getItem("scan_last_mode") || "quick";
  let qty = 0;

  if(flow==="quick"){
    qty = Number(document.getElementById("scanQty").value||0);
  }else{
    qty = Number(document.getElementById("scanCounted").value||0);
  }
  if(qty<=0){ toast("Qty must be > 0"); return; }
  localStorage.setItem("scan_last_qty", qty);

  if(scannerMode==="inventory"){
    let it = inventory.find(i => (i.barcode||"")===code && !i.archived);
    if(!it){
      it = {id: crypto.randomUUID(), name: "Inventory item " + code, unit:"", barcode:code, qty:0, archived:false};
      inventory.push(it);
    }
    it.qty = Number(it.qty||0) + qty;
    saveInventory();
    toast("Saved");
    goInventory();
    return;
  }

  let it = stock.find(i => (i.barcode||"")===code && !i.archived);
  if(!it){
    it = {id: crypto.randomUUID(), name: "Stock item " + code, unit:"", barcode:code, qty:0, archived:false};
    stock.push(it);
  }
  it.qty = Number(it.qty||0) + qty;
  saveStock();
  toast("Saved");
  goStock();
}



function renderStock(showArchived){
  const el=document.getElementById("viewStock");
  const items = stock.filter(i => !!i.archived === !!showArchived)
                     .sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  el.innerHTML=`
    <button class="secondary" onclick="goHome()">‚Üê Back</button>
    <div class="card">
      <div class="title">Stock (Inedible)</div>
      <div class="sub">Tools, supplies, equipment. No deletes ‚Äî archive only.</div>
      <div class="btnrow">
        <button onclick="openStockAdd()">Add stock</button>
        <button class="ghost" onclick="renderStock(${showArchived ? "false" : "true"})">${showArchived ? "Show active" : "Show archived"}</button>
      </div>
    </div>
    <div id="stockList"></div>
    ${renderStockDialog()}
  `;
  const list=document.getElementById("stockList");
  if(!items.length){
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<div class="sub muted">No items ${showArchived?"archived":"yet"}.</div>`;
    list.appendChild(c);
    return;
  }
  items.forEach(it=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="row">
        <div style="flex:1;min-width:0;">
          <div class="title">${it.name}</div>
          <div class="sub">On hand: <b>${Number(it.qty||0)}</b> ${it.unit||""}</div>
          ${it.barcode?`<div class="sub"><span class="muted">Barcode:</span> <code>${it.barcode}</code></div>`:""}
          ${it.archived?`<span class="badge warn">Archived</span>`:""}
        </div>
      </div>
      <div class="btnrow">
        <button class="ghost" onclick="stockAdjQty('${it.id}', +1)">+1</button>
        <button class="ghost" onclick="stockAdjQty('${it.id}', -1)">-1</button>
        ${it.archived?`<button class="ghost" onclick="stockUnarchive('${it.id}')">Unarchive</button>`:`<button class="ghost" onclick="stockArchive('${it.id}')">Archive</button>`}
      </div>
    `;
    list.appendChild(c);
  });
}

function renderStockDialog(){
  return `
    <dialog id="dlgStock" style="border:none;border-radius:16px;padding:14px;background:#161821;color:#f2f2f2;width:min(520px,96vw);">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px;">Add stock item</div>
      <div class="field">
        <div class="label">Name</div>
        <input id="stockName" autocomplete="off" />
      </div>
      <div class="field">
        <div class="label">Unit (optional)</div>
        <input id="stockUnit" autocomplete="off" placeholder="boxes, rolls, tools..." />
      </div>
      <div class="field">
        <div class="label">Barcode (optional)</div>
        <input id="stockBarcode" inputmode="numeric" autocomplete="off" />
      </div>
      <div class="btnrow" style="justify-content:flex-end;">
        <button class="secondary" onclick="closeStockAdd()">Cancel</button>
        <button onclick="saveStockAdd()">Save</button>
      </div>
    </dialog>
  `;
}

function openStockAdd(){
  const dlg=document.getElementById("dlgStock");
  document.getElementById("stockName").value="";
  document.getElementById("stockUnit").value="";
  document.getElementById("stockBarcode").value="";
  dlg.showModal();
}
function closeStockAdd(){ document.getElementById("dlgStock").close(); }

function saveStockAdd(){
  const name=(document.getElementById("stockName").value||"").trim();
  const unit=(document.getElementById("stockUnit").value||"").trim();
  const barcode=(document.getElementById("stockBarcode").value||"").trim();
  if(!name){ toast("Name required"); return; }
  stock.push({id: crypto.randomUUID(), name, unit, barcode, qty:0, archived:false});
  saveStock();
  toast("Stock added");
  closeStockAdd();
  renderStock(false);
}

function stockAdjQty(id, delta){
  const it=stock.find(x=>x.id===id);
  if(!it) return;
  it.qty=Math.max(0, Number(it.qty||0)+Number(delta||0));
  saveStock();
  toast("Saved");
  renderStock(false);
}
function stockArchive(id){
  const it=stock.find(x=>x.id===id);
  if(!it) return;
  it.archived=true;
  saveStock();
  toast("Archived");
  renderStock(false);
}
function stockUnarchive(id){
  const it=stock.find(x=>x.id===id);
  if(!it) return;
  it.archived=false;
  saveStock();
  toast("Unarchived");
  renderStock(true);
}

function renderInventory(showArchived){
  const el=document.getElementById("viewInventory");
  const items = inventory.filter(i => !!i.archived === !!showArchived)
                         .sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  el.innerHTML=`
    <button class="secondary" onclick="goHome()">‚Üê Back</button>
    <div class="card">
      <div class="title">Inventory (Edible)</div>
      <div class="sub">Add items and track quantities. No deletes ‚Äî archive only.</div>
      <div class="btnrow">
        <button onclick="openInvAdd()">Add item</button>
        <button class="ghost" onclick="renderInventory(${showArchived ? "false" : "true"})">${showArchived ? "Show active" : "Show archived"}</button>
      </div>
    </div>
    <div id="invList"></div>
    ${renderInvDialog()}
  `;
  const list=document.getElementById("invList");
  if(!items.length){
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<div class="sub muted">No items ${showArchived?"archived":"yet"}.</div>`;
    list.appendChild(c);
    return;
  }
  items.forEach(it=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="row">
        <div style="flex:1;min-width:0;">
          <div class="title">${it.name}</div>
          <div class="sub">On hand: <b>${Number(it.qty||0)}</b> ${it.unit||""}</div>
          ${it.barcode?`<div class="sub"><span class="muted">Barcode:</span> <code>${it.barcode}</code></div>`:""}
          ${it.archived?`<span class="badge warn">Archived</span>`:""}
        </div>
      </div>
      <div class="btnrow">
        <button class="ghost" onclick="adjQty('${it.id}', +1)">+1</button>
        <button class="ghost" onclick="adjQty('${it.id}', -1)">-1</button>
        ${it.archived?`<button class="ghost" onclick="unarchiveItem('${it.id}')">Unarchive</button>`:`<button class="ghost" onclick="archiveItem('${it.id}')">Archive</button>`}
      </div>
    `;
    list.appendChild(c);
  });
}
function renderInvDialog(){
  return `
    <dialog id="dlgInv" style="border:none;border-radius:16px;padding:14px;background:#161821;color:#f2f2f2;width:min(520px,96vw);">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px;">Add inventory item</div>
      <div class="field">
        <div class="label">Name</div>
        <input id="invName" autocomplete="off" />
      </div>
      <div class="field">
        <div class="label">Unit (optional)</div>
        <input id="invUnit" autocomplete="off" placeholder="bags, lbs, cans..." />
      </div>
      <div class="field">
        <div class="label">Barcode (optional)</div>
        <input id="invBarcode" inputmode="numeric" autocomplete="off" />
      </div>
      <div class="btnrow" style="justify-content:flex-end;">
        <button class="secondary" onclick="closeInvAdd()">Cancel</button>
        <button onclick="saveInvAdd()">Save</button>
      </div>
    </dialog>
  `;
}
function openInvAdd(){
  const dlg=document.getElementById("dlgInv");
  document.getElementById("invName").value="";
  document.getElementById("invUnit").value="";
  document.getElementById("invBarcode").value="";
  dlg.showModal();
}
function closeInvAdd(){ document.getElementById("dlgInv").close(); }
function saveInvAdd(){
  const name=(document.getElementById("invName").value||"").trim();
  const unit=(document.getElementById("invUnit").value||"").trim();
  const barcode=(document.getElementById("invBarcode").value||"").trim();
  if(!name){ toast("Name required"); return; }
  inventory.push({id: crypto.randomUUID(), name, unit, barcode, qty:0, archived:false});
  saveInventory();
  toast("Item added");
  closeInvAdd();
  renderInventory(false);
}
function adjQty(id, delta){
  const it=inventory.find(x=>x.id===id);
  if(!it) return;
  it.qty=Math.max(0, Number(it.qty||0)+Number(delta||0));
  saveInventory();
  toast("Saved");
  renderInventory(false);
}
function archiveItem(id){
  const it=inventory.find(x=>x.id===id);
  if(!it) return;
  it.archived=true;
  saveInventory();
  toast("Archived");
  renderInventory(false);
}
function unarchiveItem(id){
  const it=inventory.find(x=>x.id===id);
  if(!it) return;
  it.archived=false;
  saveInventory();
  toast("Unarchived");
  renderInventory(true);
}

/* Init */
(function init(){
  if(!localStorage.getItem(MIGRATION_DONE)){
    const found=findLegacyDogs();
    if(found){ showMigration(found); return; }
    localStorage.setItem(MIGRATION_DONE,"true");
  }
  goHome();
})();
</script>
</body>
</html>
