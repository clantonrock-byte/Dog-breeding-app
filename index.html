<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ‚úÖ NAV defined immediately so buttons always work -->
  <script>
    (function () {
      const VIEWS = [
        "Home",
        "InventoryMenu","InventoryAvailable","InventoryAdd","InventoryAddStock","InventoryReduceStock","InventoryTransfer",
        "Dogs","DogProfile",
        "Feeding","Care","Helpers","Records"
      ];

      let current = "Home";
      const stack = [];
      const queue = [];

      function show(name){
        VIEWS.forEach(v=>{
          const el=document.getElementById("view"+v);
          if(el) el.classList.toggle("hide", v !== name);
        });
        current = name;
        if(typeof window.__afterShow === "function"){
          try{ window.__afterShow(name); }catch(_){}
        }
      }

      window.__go = function(name){
        if(!name) return;
        if(!document.getElementById("viewHome")) return queue.push({t:"go", name});
        if(name === current) return;
        stack.push(current);
        show(name);
      };

      window.__back = function(){
        if(!document.getElementById("viewHome")) return queue.push({t:"back"});
        if(stack.length === 0) return show("Home");
        show(stack.pop());
      };

      window.__home = function(){
        if(!document.getElementById("viewHome")) return queue.push({t:"home"});
        stack.length = 0;
        show("Home");
      };

      document.addEventListener("DOMContentLoaded", ()=>{
        show("Home");
        while(queue.length){
          const a=queue.shift();
          if(a.t==="go") window.__go(a.name);
          if(a.t==="back") window.__back();
          if(a.t==="home") window.__home();
        }
      });
    })();
  </script>

  <style>
    /* ===== Back/Home row: always side-by-side on mobile ===== */
    .nav-row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .nav-row .btn{ flex:1; }

    /* ===== Deceased rainbow (Samsung-safe): draw then erase ===== */
    #rainbowOverlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: flex-end;
      background: transparent;
    }
    #rainbowOverlay.on{ display:flex; }
    #rainbowArcWrap{
      width: 140vw;
      height: 72vh;
      opacity: 0.82;
    }
    .rainbowStrokeRun{ animation: drawErase 2900ms ease forwards; }
    @keyframes drawErase{
      0%   { stroke-dashoffset: var(--len); opacity: 0.0; }
      18%  { opacity: 1.0; }
      55%  { stroke-dashoffset: 0; opacity: 1.0; }
      100% { stroke-dashoffset: calc(-1 * var(--len)); opacity: 0.0; }
    }

    /* ===== Dog profile tightened ===== */
    .action-row{ display:flex; gap:10px; margin-top:12px; }
    .action-row .btn{ flex:1; }
    .more-panel.hide{ display:none; }
    .section-toggle{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ccc;
    }
    .subtle-link-btn{ width:100%; text-align:left; }

    /* Dogs list controls */
    .dogs-menu{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .dogs-menu .btn{ flex:1; min-width: 120px; }
    .dogs-subtools{ display:flex; gap:10px; margin-top:10px; }
    .dogs-subtools .btn{ flex:1; }
    .dogs-filter-pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>

<!-- Rainbow overlay -->
<div id="rainbowOverlay" aria-hidden="true">
  <div id="rainbowArcWrap">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 650" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%"  stop-color="#ff2a2a"/>
          <stop offset="16%" stop-color="#ff8a00"/>
          <stop offset="32%" stop-color="#ffd400"/>
          <stop offset="48%" stop-color="#00b35a"/>
          <stop offset="64%" stop-color="#006eff"/>
          <stop offset="80%" stop-color="#4b00a8"/>
          <stop offset="100%" stop-color="#d66bff"/>
        </linearGradient>
        <filter id="blur"><feGaussianBlur stdDeviation="1.4"/></filter>
      </defs>

      <!-- Flip direction so "start" is on the RIGHT -->
      <g transform="translate(1200,0) scale(-1,1)">
        <path id="rainbowPath"
              d="M40 610 C220 260 480 120 680 105 C930 85 1120 240 1180 610"
              fill="none"
              stroke="url(#g)"
              stroke-width="100"
              stroke-linecap="round"
              filter="url(#blur)"
              opacity="0.92"/>
        <path id="rainbowHighlight"
              d="M70 612 C250 295 500 160 680 145 C900 125 1070 260 1140 612"
              fill="none"
              stroke="white"
              stroke-width="16"
              stroke-linecap="round"
              opacity="0.10"/>
      </g>
    </svg>
  </div>
</div>

<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryMenu')">Inventory</button>
      <button class="btn primary" onclick="__go('Dogs')">Dogs</button>
      <button class="btn primary" onclick="__go('Feeding')">Feeding</button>
      <button class="btn primary" onclick="__go('Care')">Care Timeline</button>
      <button class="btn primary" onclick="__go('Helpers')">Helpers</button>
      <button class="btn primary" onclick="__go('Records')">Records</button>
    </div>
  </section>

  <!-- DOGS -->
  <section id="viewDogs" class="card hide">
    <h2>Dogs</h2>

    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <!-- Dogs menu buttons -->
    <div class="dogs-menu">
      <button class="btn primary" id="btnViewMales">View males</button>
      <button class="btn primary" id="btnViewFemales">View females</button>
      <button class="btn primary" id="btnAddDog">Add dog</button>
    </div>

    <!-- Sub tools -->
    <div class="dogs-subtools">
      <button class="btn" id="btnToggleArchivedDogs">Show archived</button>
      <button class="btn" id="btnShowUnassigned">Needs sex set</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      Current view: <span class="dogs-filter-pill" id="dogsCurrentViewPill">All</span>
      <span id="dogsSortHint" class="muted small"></span>
    </div>

    <div id="dogsListMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="dogsList"></div>

    <div id="dogsArchivedWrap" class="hide" style="margin-top:14px;">
      <div class="muted small" id="dogsArchivedMeta"></div>
      <div id="dogsArchivedList"></div>
    </div>

    <div id="dogsUnassignedWrap" class="hide" style="margin-top:14px;">
      <div class="muted small" id="dogsUnassignedMeta"></div>
      <div id="dogsUnassignedList"></div>
    </div>
  </section>

  <!-- DOG PROFILE -->
  <section id="viewDogProfile" class="card hide">
    <h2 id="dogProfileTitle">Dog Profile</h2>

    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div id="dogArchivedBanner" class="timeline-item hide" style="margin-top:12px;">
      <div><strong id="dogArchivedBannerText">Archived</strong></div>
      <div class="muted small" id="dogArchivedBannerMeta"></div>
    </div>

    <!-- Photo block (unchanged size) -->
    <div class="timeline-item" style="margin-top:12px;">
      <div><strong>Photo</strong></div>
      <div class="muted small">Tap photo/placeholder to add or update (active). Archived is view-only.</div>

      <div id="dogPhotoTap" style="margin-top:10px; border:1px dashed #bbb; border-radius:12px; padding:12px; text-align:center;">
        <div id="dogPhotoPlaceholder" class="muted small">Tap to add photo</div>
        <img id="dogPhotoImg" alt="Dog photo" style="display:none; max-width:100%; border-radius:12px;" />
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnViewPhoto">View photo</button>
      </div>
    </div>

    <!-- Tight header -->
    <div class="timeline-item">
      <div class="section-toggle">
        <strong>Status</strong>
        <span class="pill" id="dogStatusPill">Adult</span>
      </div>
      <div class="muted small" id="dogStatusTimestamps" style="margin-top:6px;"></div>

      <div style="margin-top:10px;">
        <strong id="dogCallNameDisplay" style="font-size:18px;">(no name)</strong>
      </div>

      <div class="action-row">
        <button class="btn primary" id="btnDoneDog">Done</button>
        <button class="btn" id="btnNotesDog">Notes</button>
        <button class="btn" id="btnMoreDog">More ‚ñæ</button>
      </div>

      <div class="muted small" id="dogSaveStatus" style="margin-top:10px;"></div>
    </div>

    <div id="dogMorePanel" class="more-panel hide">

      <div class="timeline-item" id="secBasics">
        <strong>Basics</strong>

        <label class="label">Call name (required)</label>
        <input id="dogCallName" />

        <label class="label">Registered name (optional)</label>
        <input id="dogRegisteredName" />

        <label class="label">Kennel name (optional)</label>
        <input id="dogKennelName" />

        <label class="label">Nicknames (optional)</label>
        <input id="dogNicknames" placeholder="Comma-separated" />

        <label class="label">Breed (default GSP)</label>
        <input id="dogBreed" />

        <div class="grid2">
          <div>
            <label class="label">Sex</label>
            <select id="dogSex">
              <option value="">(unknown)</option>
              <option>Male (intact)</option>
              <option>Male (neutered)</option>
              <option>Female (intact)</option>
              <option>Female (spayed)</option>
            </select>
          </div>
          <div>
            <label class="label">DOB (optional)</label>
            <input id="dogDob" placeholder="YYYY-MM-DD" />
            <div class="muted small" style="margin-top:6px;">
              <label style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" id="dogDobEstimated" />
                Estimated DOB
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="timeline-item" id="secHealth">
        <strong>ID &amp; Health</strong>
        <label class="label">Microchip ID (optional)</label>
        <input id="dogMicrochip" />
        <div style="margin-top:10px;">
          <div><strong>Rabies immunization</strong></div>
          <div class="muted small" id="dogRabiesSummary">No rabies record on file</div>
        </div>
      </div>

      <div class="timeline-item" id="secStatus">
        <strong>Status</strong>

        <label class="label">Status</label>
        <select id="dogStatus">
          <option>Puppy</option>
          <option>Adult</option>
          <option>Retired</option>
          <option>Transferred</option>
          <option>Deceased</option>
        </select>

        <div id="statusNoteWrap" class="hide" style="margin-top:10px;">
          <label class="label">Status note (required for Transferred / Deceased)</label>
          <input id="dogStatusNote" placeholder="Short factual note" />
        </div>

        <div class="muted small" style="margin-top:10px;">
          Transferred and Deceased will archive this profile (still accessible later).
        </div>
      </div>

      <div class="timeline-item" id="secNotes">
        <strong>Notes</strong>
        <div class="muted small">Notes remain editable even when archived.</div>
        <textarea id="dogNotes" rows="5" style="width:100%; margin-top:8px;"></textarea>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnSaveDog">Done</button>
          <button class="btn" id="btnCancelDog">Cancel</button>
        </div>
      </div>

      <div class="timeline-item">
        <strong>Life status</strong>
        <div class="muted small" style="margin-top:6px;">
          Transferred / Deceased options are available under Status.
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn subtle-link-btn" id="btnReviewLifeStatus">Review transfer / deceased options</button>
        </div>
      </div>

    </div>
  </section>

  <!-- INVENTORY MENU -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryAvailable')">Inventory available</button>
      <button class="btn primary" onclick="__go('InventoryAdd')">Add to inventory</button>
      <button class="btn primary" onclick="__go('InventoryAddStock')">Add stock</button>
      <button class="btn primary" onclick="__go('InventoryReduceStock')">Reduce stock</button>
      <button class="btn primary" onclick="__go('InventoryTransfer')">Transfer inventory</button>
    </div>
  </section>

  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>
    <div id="invMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="invList"></div>
    <div id="invArchived" class="hide"></div>
  </section>

  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnOpenAddDialog">+ Create item definition</button>
      <button class="btn" id="btnScanForAdd">Scan now (QR or barcode)</button>
    </div>
  </section>

  <section id="viewInventoryAddStock" class="card hide">
    <h2>Add stock</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanAddStock">Scan item</button>
      <button class="btn" id="btnAddStockRefresh">Refresh list</button>
    </div>
    <label class="label">Search (optional)</label>
    <input id="addStockSearch" placeholder="Type to filter‚Ä¶" />
    <label class="label">Select item</label>
    <select id="addStockSelect"></select>
    <div id="addStockForm" class="hide" style="margin-top:12px;">
      <label class="label">Quantity to add</label>
      <input id="addStockQty" inputmode="decimal" placeholder="e.g., 5" />
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnAddStockConfirm">Done</button>
        <button class="btn" id="btnAddStockCancel">Cancel</button>
      </div>
      <div id="addStockStatus" class="muted small" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="viewInventoryReduceStock" class="card hide">
    <h2>Reduce stock</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanReduce">Scan item</button>
      <button class="btn" id="btnReduceRefresh">Refresh list</button>
    </div>
    <label class="label">Search (optional)</label>
    <input id="reduceSearch" placeholder="Type to filter‚Ä¶" />
    <label class="label">Select item</label>
    <select id="reduceSelect"></select>
    <div id="reduceForm" class="hide" style="margin-top:12px;">
      <label class="label">Action</label>
      <select id="reduceAction"><option>Used</option><option>Discarded</option></select>
      <label class="label">Quantity</label>
      <input id="reduceQty" inputmode="decimal" placeholder="e.g., 2" />
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnReduceConfirm">Done</button>
        <button class="btn" id="btnReduceCancel">Cancel</button>
      </div>
      <div id="reduceStatus" class="muted small" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>
    <div class="nav-row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanTransfer">Scan item</button>
      <button class="btn" id="btnTransferRefresh">Refresh list</button>
    </div>
    <label class="label">Search (optional)</label>
    <input id="transferSearch" placeholder="Type to filter‚Ä¶" />
    <label class="label">Select item</label>
    <select id="transferSelect"></select>
    <div id="transferForm" class="hide" style="margin-top:12px;">
      <label class="label">Quantity</label>
      <input id="transferQty" inputmode="decimal" placeholder="e.g., 1" />
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnTransferConfirm">Done</button>
        <button class="btn" id="btnTransferCancel">Cancel</button>
      </div>
      <div id="transferStatus" class="muted small" style="margin-top:10px;"></div>
    </div>
  </section>

  <!-- PLACEHOLDERS -->
  <section id="viewFeeding" class="card hide">
    <h2>Feeding</h2>
    <div class="nav-row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div>
  </section>
  <section id="viewCare" class="card hide">
    <h2>Care Timeline</h2>
    <div class="nav-row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div>
  </section>
  <section id="viewHelpers" class="card hide">
    <h2>Helpers</h2>
    <div class="nav-row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div>
  </section>
  <section id="viewRecords" class="card hide">
    <h2>Records</h2>
    <div class="nav-row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div>
  </section>

</main>

<!-- Photo chooser -->
<dialog id="dlgPhotoChoice" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Set current photo</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btn primary" id="btnTakePhoto">Take photo</button>
        <button type="button" class="btn" id="btnChoosePhoto">Choose from gallery</button>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
<input id="fileGallery" type="file" accept="image/*" style="display:none;" />

<!-- Add inventory dialog -->
<dialog id="dlgInv" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Inventory item</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <label class="label">Item name</label>
      <input id="invName" />
      <label class="label">Identifier type</label>
      <select id="invIdType"><option>None</option><option>Barcode</option><option>QR</option></select>
      <label class="label">Identifier value</label>
      <input id="invIdValue" />
      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" id="btnScanInsideAdd">Scan now (QR or barcode)</button>
        <button type="button" class="btn" id="btnDeleteId">Delete now</button>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="btnSaveInv" value="ok">Done</button>
    </div>
  </form>
</dialog>

<!-- Scan dialog -->
<dialog id="dlgScan" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Scan</h3>
      <button class="info-btn" value="cancel" aria-label="Close" id="btnCloseScan">‚úï</button>
    </div>
    <div class="dlg-b">
      <video id="scanVideo" playsinline autoplay muted></video>
      <div id="scanResultBox" class="scan-result hide">
        <div class="muted small">Identifier captured</div>
        <div id="scanValue" class="scan-value"></div>
      </div>
      <div id="scanHelp" class="muted small" style="margin-top:10px;"></div>
      <label class="label" style="margin-top:12px;">Manual entry</label>
      <input id="scanManual" />
    </div>
    <div class="dlg-f">
      <button type="button" class="btn" id="btnRescan">Rescan</button>
      <button type="button" class="btn primary" id="btnConfirmScan">Done</button>
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  const INV_KEY="breederPro_inventory_store_v1";
  const DOG_KEY="breederPro_dogs_store_v1";

  const nowISO=()=>new Date().toISOString();
  const fmt=(ts)=>{ try{return new Date(ts).toLocaleString();}catch{return "";} };
  const setText=(id,msg)=>{ const el=document.getElementById(id); if(el) el.textContent=msg||""; };

  function loadInv(){ try{ const raw=localStorage.getItem(INV_KEY); if(!raw) return {inventory:[]}; const o=JSON.parse(raw); if(!Array.isArray(o.inventory)) o.inventory=[]; return o; }catch{ return {inventory:[]}; } }
  function saveInv(o){ localStorage.setItem(INV_KEY, JSON.stringify(o)); }
  function loadDogs(){ try{ const raw=localStorage.getItem(DOG_KEY); if(!raw) return {dogs:[]}; const o=JSON.parse(raw); if(!Array.isArray(o.dogs)) o.dogs=[]; return o; }catch{ return {dogs:[]}; } }
  function saveDogs(o){ localStorage.setItem(DOG_KEY, JSON.stringify(o)); }

  const invActive=()=>loadInv().inventory.filter(i=>!i.archived);

  // ===== Rainbow (draw then erase) =====
  function rainbowMoment(){
    const overlay=document.getElementById("rainbowOverlay");
    const path=document.getElementById("rainbowPath");
    const hi=document.getElementById("rainbowHighlight");
    if(!overlay || !path) return;

    const len = path.getTotalLength();
    path.style.setProperty("--len", `${len}`);
    path.style.strokeDasharray = `${len}`;
    path.style.strokeDashoffset = `${len}`;

    if(hi){
      const hlen = hi.getTotalLength();
      hi.style.setProperty("--len", `${hlen}`);
      hi.style.strokeDasharray = `${hlen}`;
      hi.style.strokeDashoffset = `${hlen}`;
    }

    overlay.classList.remove("on");
    path.classList.remove("rainbowStrokeRun");
    if(hi) hi.classList.remove("rainbowStrokeRun");
    void overlay.offsetHeight;

    overlay.classList.add("on");
    path.classList.add("rainbowStrokeRun");
    if(hi) hi.classList.add("rainbowStrokeRun");

    setTimeout(()=>{
      overlay.classList.remove("on");
      path.classList.remove("rainbowStrokeRun");
      if(hi) hi.classList.remove("rainbowStrokeRun");
    }, 3000);
  }

  // ===== Inventory =====
  function renderInv(){
    const store=loadInv();
    const items=store.inventory.filter(i=>!i.archived);
    const archived=store.inventory.filter(i=>i.archived);
    const meta=document.getElementById("invMeta");
    const list=document.getElementById("invList");
    const arch=document.getElementById("invArchived");
    if(meta) meta.textContent=`Active: ${items.length}. Archived: ${archived.length}.`;
    if(list){
      list.innerHTML = items.length ? items.map(i=>`
        <div class="timeline-item">
          <div><strong>${i.name}</strong></div>
          <div class="muted small">On hand: ${Number(i.qty||0)}</div>
        </div>
      `).join("") : `<div class="muted small">No active items.</div>`;
    }
    if(arch){
      arch.innerHTML = archived.length ? archived.map(i=>`
        <div class="timeline-item">
          <div><strong>${i.name}</strong></div>
          <div class="muted small">Archived ‚Ä¢ On hand: ${Number(i.qty||0)}</div>
        </div>
      `).join("") : `<div class="muted small">No archived items.</div>`;
    }
  }

  function populateSelect(selectId){
    const sel=document.getElementById(selectId);
    if(!sel) return;
    const items=invActive();
    sel.innerHTML="";
    const o0=document.createElement("option"); o0.value=""; o0.textContent="Select item‚Ä¶"; sel.appendChild(o0);
    items.forEach(i=>{
      const opt=document.createElement("option");
      opt.value=i.itemId;
      opt.textContent=`${i.name} (on hand: ${Number(i.qty||0)})`;
      sel.appendChild(opt);
    });
  }

  function filterSelect(searchId, selectId){
    const q=(document.getElementById(searchId)?.value||"").trim().toLowerCase();
    const sel=document.getElementById(selectId);
    if(!sel) return;
    const items=invActive().filter(i=>{
      if(!q) return true;
      return (`${i.name||""} ${(i.identifierValue||"")}`).toLowerCase().includes(q);
    });
    sel.innerHTML="";
    const o0=document.createElement("option"); o0.value=""; o0.textContent="Select item‚Ä¶"; sel.appendChild(o0);
    items.forEach(i=>{
      const opt=document.createElement("option");
      opt.value=i.itemId;
      opt.textContent=`${i.name} (on hand: ${Number(i.qty||0)})`;
      sel.appendChild(opt);
    });
  }

  function openInvDialog(){
    document.getElementById("invName").value="";
    document.getElementById("invIdType").value="Barcode";
    document.getElementById("invIdValue").value="";
    document.getElementById("dlgInv").showModal();
  }

  function saveInvDef(){
    const name=(document.getElementById("invName").value||"").trim();
    if(!name){ alert("Item name required."); return; }
    const store=loadInv();
    store.inventory.push({
      itemId:"inv_"+Date.now()+"_"+Math.random().toString(16).slice(2),
      name,
      identifierType:document.getElementById("invIdType").value,
      identifierValue:(document.getElementById("invIdValue").value||"").trim(),
      qty:0,
      archived:false
    });
    saveInv(store);
    document.getElementById("dlgInv").close();
    renderInv();
    populateSelect("addStockSelect"); populateSelect("reduceSelect"); populateSelect("transferSelect");
  }

  let addStockItemId=null, reduceItemId=null, transferItemId=null;
  function showAddStock(itemId){ addStockItemId=itemId; document.getElementById("addStockForm").classList.remove("hide"); document.getElementById("addStockQty").value="1"; setText("addStockStatus",""); }
  function showReduce(itemId){ reduceItemId=itemId; document.getElementById("reduceForm").classList.remove("hide"); document.getElementById("reduceQty").value="1"; setText("reduceStatus",""); }
  function showTransfer(itemId){ transferItemId=itemId; document.getElementById("transferForm").classList.remove("hide"); document.getElementById("transferQty").value="1"; setText("transferStatus",""); }

  function applyAddStock(){
    const qty=Math.abs(Number(document.getElementById("addStockQty").value||"0")||0);
    if(!addStockItemId || qty<=0) return setText("addStockStatus","Pick item + qty");
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===addStockItemId);
    if(!it) return setText("addStockStatus","Item not found");
    it.qty=Number(it.qty||0)+qty;
    saveInv(store);
    setText("addStockStatus","Done.");
    renderInv(); populateSelect("addStockSelect");
  }

  function applyReduce(){
    const qty=Math.abs(Number(document.getElementById("reduceQty").value||"0")||0);
    if(!reduceItemId || qty<=0) return setText("reduceStatus","Pick item + qty");
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===reduceItemId);
    if(!it) return setText("reduceStatus","Item not found");
    it.qty=Math.max(0, Number(it.qty||0)-qty);
    saveInv(store);
    setText("reduceStatus","Done.");
    renderInv(); populateSelect("reduceSelect");
  }

  function applyTransfer(){
    const qty=Math.abs(Number(document.getElementById("transferQty").value||"0")||0);
    if(!transferItemId || qty<=0) return setText("transferStatus","Pick item + qty");
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===transferItemId);
    if(!it) return setText("transferStatus","Item not found");
    it.qty=Math.max(0, Number(it.qty||0)-qty);
    saveInv(store);
    setText("transferStatus","Done.");
    renderInv(); populateSelect("transferSelect");
  }

  // ===== Dogs: view males/females + sort intact first =====
  let currentDogId=null;
  let dogsViewMode = "All"; // "Males" | "Females" | "Unassigned" | "All"

  function addDog(callName){
    const store=loadDogs();
    store.dogs.push({
      dogId:"dog_"+Date.now()+"_"+Math.random().toString(16).slice(2),
      callName,
      registeredName:"",
      kennelName:"",
      nicknames:[],
      breed:"German Shorthaired Pointer",
      sex:"",
      dob:"",
      dobEstimated:false,
      microchip:"",
      rabiesLastDate:null,
      status:"Adult",
      statusChangedAt: nowISO(),
      archived:false,
      archivedAt:null,
      statusNote:"",
      notes:"",
      photoDataUrl:""
    });
    saveDogs(store);
    renderDogs();
  }

  function getDog(id){ return loadDogs().dogs.find(d=>d.dogId===id) || null; }

  function sexCategory(sexStr){
    const s=(sexStr||"").toLowerCase();
    if(s.startsWith("male")) return "male";
    if(s.startsWith("female")) return "female";
    return "unknown";
  }
  function isAltered(sexStr){
    const s=(sexStr||"").toLowerCase();
    return s.includes("neutered") || s.includes("spayed");
  }

  function sortDogsIntactFirst(a,b){
    const ai = isAltered(a.sex) ? 1 : 0;  // intact first => altered is 1
    const bi = isAltered(b.sex) ? 1 : 0;
    if(ai !== bi) return ai - bi;
    const an=(a.callName||"").toLowerCase();
    const bn=(b.callName||"").toLowerCase();
    return an.localeCompare(bn);
  }

  function renderDogs(){
    const store=loadDogs();
    const all=store.dogs || [];
    const archived = all.filter(d=>d.archived);

    const showArchived = !document.getElementById("dogsArchivedWrap").classList.contains("hide");
    const showUnassigned = !document.getElementById("dogsUnassignedWrap").classList.contains("hide");

    // Filter per view mode
    let list = all.filter(d=>!d.archived);
    if(dogsViewMode==="Males"){
      list = list.filter(d=>sexCategory(d.sex)==="male");
    } else if(dogsViewMode==="Females"){
      list = list.filter(d=>sexCategory(d.sex)==="female");
    } else if(dogsViewMode==="Unassigned"){
      list = list.filter(d=>sexCategory(d.sex)==="unknown");
    }

    // Sorting rule: intact first, altered after
    list.sort(sortDogsIntactFirst);

    document.getElementById("dogsCurrentViewPill").textContent = dogsViewMode;
    document.getElementById("dogsSortHint").textContent =
      (dogsViewMode==="Males" || dogsViewMode==="Females") ? " ‚Ä¢ intact first, altered after" : "";

    document.getElementById("dogsListMeta").textContent = `Dogs shown: ${list.length}`;
    document.getElementById("dogsList").innerHTML = list.length ? list.map(d=>`
      <div class="timeline-item">
        <div class="row" style="justify-content:space-between; gap:10px;">
          <div>
            <div><strong>${d.callName}</strong></div>
            <div class="muted small">Sex: ${d.sex || "(unknown)"} ‚Ä¢ Status: ${d.status}</div>
          </div>
          <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
        </div>
      </div>
    `).join("") : `<div class="muted small">No dogs found in this view.</div>`;

    // Archived list (hidden by default)
    if(showArchived){
      document.getElementById("dogsArchivedMeta").textContent = `Archived dogs: ${archived.length}`;
      document.getElementById("dogsArchivedList").innerHTML = archived.length ? archived.sort((a,b)=> (a.callName||"").localeCompare(b.callName||"")).map(d=>`
        <div class="timeline-item">
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div>
              <div><strong>${d.callName}</strong></div>
              <div class="muted small">Archived ‚Ä¢ ${d.status} ‚Ä¢ ${d.archivedAt ? fmt(d.archivedAt) : ""}</div>
            </div>
            <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
          </div>
        </div>
      `).join("") : `<div class="muted small">No archived dogs.</div>`;
    }

    // Unassigned list (optional view)
    if(showUnassigned){
      const unassigned = all.filter(d=>!d.archived && sexCategory(d.sex)==="unknown").sort((a,b)=>(a.callName||"").localeCompare(b.callName||""));
      document.getElementById("dogsUnassignedMeta").textContent = `Needs sex set: ${unassigned.length}`;
      document.getElementById("dogsUnassignedList").innerHTML = unassigned.length ? unassigned.map(d=>`
        <div class="timeline-item">
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div>
              <div><strong>${d.callName}</strong></div>
              <div class="muted small">Sex: (unknown) ‚Ä¢ Status: ${d.status}</div>
            </div>
            <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
          </div>
        </div>
      `).join("") : `<div class="muted small">None right now.</div>`;
    }
  }

  // Pill rule: show ONLY "Archived" when archived
  function updateStatusPill(d){
    const pill=document.getElementById("dogStatusPill");
    if(d.archived) pill.textContent = "Archived";
    else pill.textContent = d.status;
  }

  function renderDogProfile(d){
    currentDogId=d.dogId;
    updateStatusPill(d);

    document.getElementById("dogCallNameDisplay").textContent = d.callName || "(no name)";
    document.getElementById("dogProfileTitle").textContent = d.callName || "Dog Profile";

    const banner=document.getElementById("dogArchivedBanner");
    if(d.archived){
      banner.classList.remove("hide");
      document.getElementById("dogArchivedBannerText").textContent="Archived";
      document.getElementById("dogArchivedBannerMeta").textContent = d.archivedAt ? `Archived at: ${fmt(d.archivedAt)}` : "";
    } else banner.classList.add("hide");

    // Truth gently in details
    const lines=[];
    if(d.statusChangedAt) lines.push(`Recorded: ${fmt(d.statusChangedAt)}`);
    lines.push(`Status: ${d.status}`);
    document.getElementById("dogStatusTimestamps").textContent = lines.join(" ‚Ä¢ ");

    // Photo
    const img=document.getElementById("dogPhotoImg");
    const ph=document.getElementById("dogPhotoPlaceholder");
    if(d.photoDataUrl){
      img.src=d.photoDataUrl; img.style.display="block"; ph.style.display="none";
    } else {
      img.src=""; img.style.display="none"; ph.style.display="block";
    }
    document.getElementById("btnViewPhoto").disabled=!d.photoDataUrl;

    // Fields
    document.getElementById("dogCallName").value=d.callName||"";
    document.getElementById("dogRegisteredName").value=d.registeredName||"";
    document.getElementById("dogKennelName").value=d.kennelName||"";
    document.getElementById("dogNicknames").value=(d.nicknames||[]).join(", ");
    document.getElementById("dogBreed").value=d.breed||"German Shorthaired Pointer";
    document.getElementById("dogSex").value=d.sex||"";
    document.getElementById("dogDob").value=d.dob||"";
    document.getElementById("dogDobEstimated").checked=!!d.dobEstimated;
    document.getElementById("dogMicrochip").value=d.microchip||"";
    document.getElementById("dogRabiesSummary").textContent=d.rabiesLastDate?`Last recorded: ${d.rabiesLastDate}`:"No rabies record on file";
    document.getElementById("dogStatus").value=d.status||"Adult";
    document.getElementById("dogStatusNote").value=d.statusNote||"";
    document.getElementById("dogNotes").value=d.notes||"";

    const st=document.getElementById("dogStatus").value;
    const wrap=document.getElementById("statusNoteWrap");
    if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide"); else wrap.classList.add("hide");

    document.getElementById("dogMorePanel").classList.add("hide");
    document.getElementById("btnMoreDog").textContent="More ‚ñæ";
    setText("dogSaveStatus","");
  }

  window.__openDog=function(id){
    const d=getDog(id);
    if(!d) return;
    __go("DogProfile");
    renderDogProfile(d);
  };

  function saveDogProfileAndMaybeExit(exitAfter){
    const store=loadDogs();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;

    const prevStatus=d.status;

    d.callName=(document.getElementById("dogCallName").value||"").trim()||d.callName;
    d.registeredName=(document.getElementById("dogRegisteredName").value||"").trim();
    d.kennelName=(document.getElementById("dogKennelName").value||"").trim();
    d.nicknames=(document.getElementById("dogNicknames").value||"").split(",").map(s=>s.trim()).filter(Boolean);
    d.breed=(document.getElementById("dogBreed").value||"").trim()||"German Shorthaired Pointer";
    d.sex=document.getElementById("dogSex").value||"";
    d.dob=(document.getElementById("dogDob").value||"").trim();
    d.dobEstimated=!!document.getElementById("dogDobEstimated").checked;
    d.microchip=(document.getElementById("dogMicrochip").value||"").trim();
    d.notes=(document.getElementById("dogNotes").value||"").trim();

    const newStatus=document.getElementById("dogStatus").value;
    if(newStatus!==d.status){
      d.status=newStatus;
      d.statusChangedAt=nowISO();
    }

    if(newStatus==="Transferred"||newStatus==="Deceased"){
      const note=(document.getElementById("dogStatusNote").value||"").trim();
      if(!note){
        setText("dogSaveStatus","Status note required.");
        alert("Status note is required for Transferred/Deceased.");
        return;
      }
      d.statusNote=note;
      d.archived=true;
      d.archivedAt=nowISO();
    } else {
      d.archived=false;
      d.archivedAt=null;
      d.statusNote=(document.getElementById("dogStatusNote").value||"").trim();
    }

    saveDogs(store);
    renderDogs();
    renderDogProfile(d);

    if(d.status==="Deceased"){
      setText("dogSaveStatus",
        "Recorded with care.\nThank you for taking the time to record this.\nThis profile has been archived and can be viewed at any time."
      );
      if(prevStatus!=="Deceased") rainbowMoment();
    } else {
      setText("dogSaveStatus","Done.");
    }

    if(exitAfter){
      setTimeout(()=>{ __go("Dogs"); }, d.status==="Deceased" ? 1200 : 350);
    }
  }

  // Photo
  async function compressImageToDataUrl(file){
    const dataUrl=await new Promise((resolve,reject)=>{
      const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
    });
    const img=new Image(); img.src=dataUrl; await new Promise(res=>img.onload=res);
    const maxEdge=900;
    const scale=Math.min(1, maxEdge/Math.max(img.width,img.height));
    const w=Math.max(1, Math.round(img.width*scale));
    const h=Math.max(1, Math.round(img.height*scale));
    const c=document.createElement("canvas"); c.width=w; c.height=h;
    c.getContext("2d").drawImage(img,0,0,w,h);
    return c.toDataURL("image/jpeg",0.78);
  }

  async function setDogPhoto(file){
    const store=loadDogs();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;
    if(d.archived) return alert("Archived dogs are view-only.");
    d.photoDataUrl=await compressImageToDataUrl(file);
    saveDogs(store);
    renderDogs();
    renderDogProfile(d);
  }

  // Scan
  let scanStream=null, lastScanValue="", scanContext="transfer";
  function stopScan(){
    const video=document.getElementById("scanVideo");
    if(video) video.pause();
    if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  }
  async function startScan(){
    const video=document.getElementById("scanVideo");
    const help=document.getElementById("scanHelp");
    const box=document.getElementById("scanResultBox");
    const val=document.getElementById("scanValue");
    lastScanValue=""; box.classList.add("hide"); val.textContent=""; help.textContent="";
    try{
      scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
      video.srcObject=scanStream; video.muted=true; video.autoplay=true;
      try{ await video.play(); }catch{ setTimeout(()=>{ video.play().catch(()=>{}); },250); }
    }catch{
      help.textContent="Camera unavailable. Manual entry works.";
      return;
    }
    if(!("BarcodeDetector" in window)){
      help.textContent="Scanner unsupported. Manual entry works.";
      return;
    }
    let detector; try{ detector=new BarcodeDetector(); }catch{ detector=null; }
    const loop=async()=>{
      if(!scanStream || !detector) return;
      try{
        const codes=await detector.detect(video);
        if(codes && codes.length){
          const raw=codes[0].rawValue||"";
          if(raw){
            lastScanValue=raw;
            box.classList.remove("hide");
            val.textContent=raw;
            stopScan();
            return;
          }
        }
      }catch{}
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }
  function openScan(context){
    scanContext=context||"transfer";
    document.getElementById("scanManual").value="";
    document.getElementById("dlgScan").showModal();
    startScan();
  }
  function closeScan(){
    stopScan();
    document.getElementById("dlgScan").close();
  }
  function findMatch(code){
    const c=String(code||"").trim();
    const store=loadInv();
    return store.inventory.find(i =>
      (i.identifierType==="Barcode"||i.identifierType==="QR") &&
      String(i.identifierValue||"").trim()===c
    ) || null;
  }
  function confirmScan(){
    const manual=(document.getElementById("scanManual").value||"").trim();
    const code=(lastScanValue && lastScanValue.trim()) ? lastScanValue.trim() : manual;
    if(!code){
      document.getElementById("scanHelp").textContent="No code captured. Manual entry works.";
      return;
    }
    if(scanContext==="add"){
      document.getElementById("invIdType").value="Barcode";
      document.getElementById("invIdValue").value=code;
      closeScan();
      return;
    }
    const match=findMatch(code);
    closeScan();
    if(!match) return;
    if(scanContext==="addstock") showAddStock(match.itemId);
    if(scanContext==="reduce") showReduce(match.itemId);
    if(scanContext==="transfer") showTransfer(match.itemId);
  }

  // afterShow
  window.__afterShow=function(view){
    if(view==="Dogs") renderDogs();
    if(view==="DogProfile"){
      const d=getDog(currentDogId);
      if(d) renderDogProfile(d);
    }
    if(view==="InventoryAvailable") renderInv();
    if(view==="InventoryAddStock") populateSelect("addStockSelect");
    if(view==="InventoryReduceStock") populateSelect("reduceSelect");
    if(view==="InventoryTransfer") populateSelect("transferSelect");
  };

  // Bind
  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("btnTalk").addEventListener("click", ()=>alert("Voice may be used at any time."));

    // Dogs page menu buttons
    document.getElementById("btnViewMales").addEventListener("click", ()=>{
      dogsViewMode="Males";
      document.getElementById("dogsUnassignedWrap").classList.add("hide");
      renderDogs();
    });
    document.getElementById("btnViewFemales").addEventListener("click", ()=>{
      dogsViewMode="Females";
      document.getElementById("dogsUnassignedWrap").classList.add("hide");
      renderDogs();
    });
    document.getElementById("btnShowUnassigned").addEventListener("click", ()=>{
      dogsViewMode="Unassigned";
      document.getElementById("dogsUnassignedWrap").classList.remove("hide");
      renderDogs();
    });

    document.getElementById("btnAddDog").addEventListener("click", ()=>{
      const name=prompt("Call name (required):");
      if(!name) return;
      addDog(name.trim());
    });

    document.getElementById("btnToggleArchivedDogs").addEventListener("click", ()=>{
      document.getElementById("dogsArchivedWrap").classList.toggle("hide");
      renderDogs();
    });

    // Profile actions
    document.getElementById("btnDoneDog").addEventListener("click", ()=> saveDogProfileAndMaybeExit(true));
    document.getElementById("btnNotesDog").addEventListener("click", ()=>{
      document.getElementById("dogMorePanel").classList.remove("hide");
      document.getElementById("btnMoreDog").textContent="More ‚ñ¥";
      document.getElementById("secNotes").scrollIntoView({behavior:"smooth", block:"start"});
      document.getElementById("dogNotes").focus();
    });
    document.getElementById("btnMoreDog").addEventListener("click", ()=>{
      const panel=document.getElementById("dogMorePanel");
      const isHidden=panel.classList.contains("hide");
      panel.classList.toggle("hide");
      document.getElementById("btnMoreDog").textContent = isHidden ? "More ‚ñ¥" : "More ‚ñæ";
    });
    document.getElementById("btnReviewLifeStatus").addEventListener("click", ()=>{
      document.getElementById("dogMorePanel").classList.remove("hide");
      document.getElementById("btnMoreDog").textContent="More ‚ñ¥";
      document.getElementById("secStatus").scrollIntoView({behavior:"smooth", block:"start"});
      document.getElementById("dogStatus").focus();
    });

    document.getElementById("btnSaveDog").addEventListener("click", ()=> saveDogProfileAndMaybeExit(false));
    document.getElementById("btnCancelDog").addEventListener("click", ()=>{ setText("dogSaveStatus",""); __back(); });

    document.getElementById("dogStatus").addEventListener("change", ()=>{
      const st=document.getElementById("dogStatus").value;
      const wrap=document.getElementById("statusNoteWrap");
      if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide"); else wrap.classList.add("hide");
    });

    // Photo
    document.getElementById("dogPhotoTap").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(!d) return;
      if(d.archived){
        if(d.photoDataUrl) window.open(d.photoDataUrl,"_blank");
        return;
      }
      document.getElementById("dlgPhotoChoice").showModal();
    });
    document.getElementById("btnViewPhoto").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(d?.photoDataUrl) window.open(d.photoDataUrl,"_blank");
    });
    document.getElementById("btnTakePhoto").addEventListener("click", ()=>document.getElementById("fileCamera").click());
    document.getElementById("btnChoosePhoto").addEventListener("click", ()=>document.getElementById("fileGallery").click());
    document.getElementById("fileCamera").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhoto(f);
      document.getElementById("dlgPhotoChoice").close();
    });
    document.getElementById("fileGallery").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhoto(f);
      document.getElementById("dlgPhotoChoice").close();
    });

    // Inventory
    document.getElementById("btnInvRefresh").addEventListener("click", renderInv);
    document.getElementById("btnInvToggleArchived").addEventListener("click", ()=>document.getElementById("invArchived").classList.toggle("hide"));
    document.getElementById("btnOpenAddDialog").addEventListener("click", openInvDialog);
    document.getElementById("btnSaveInv").addEventListener("click", (e)=>{ e.preventDefault(); saveInvDef(); });
    document.getElementById("btnDeleteId").addEventListener("click", ()=>{ document.getElementById("invIdValue").value=""; });

    document.getElementById("btnScanForAdd").addEventListener("click", ()=>openScan("add"));
    document.getElementById("btnScanInsideAdd").addEventListener("click", ()=>openScan("add"));
    document.getElementById("btnScanAddStock").addEventListener("click", ()=>openScan("addstock"));
    document.getElementById("btnScanReduce").addEventListener("click", ()=>openScan("reduce"));
    document.getElementById("btnScanTransfer").addEventListener("click", ()=>openScan("transfer"));

    document.getElementById("btnAddStockRefresh").addEventListener("click", ()=>populateSelect("addStockSelect"));
    document.getElementById("btnReduceRefresh").addEventListener("click", ()=>populateSelect("reduceSelect"));
    document.getElementById("btnTransferRefresh").addEventListener("click", ()=>populateSelect("transferSelect"));

    document.getElementById("addStockSelect").addEventListener("change", (e)=>{ if(e.target.value) showAddStock(e.target.value); });
    document.getElementById("reduceSelect").addEventListener("change", (e)=>{ if(e.target.value) showReduce(e.target.value); });
    document.getElementById("transferSelect").addEventListener("change", (e)=>{ if(e.target.value) showTransfer(e.target.value); });

    document.getElementById("addStockSearch").addEventListener("input", ()=>filterSelect("addStockSearch","addStockSelect"));
    document.getElementById("reduceSearch").addEventListener("input", ()=>filterSelect("reduceSearch","reduceSelect"));
    document.getElementById("transferSearch").addEventListener("input", ()=>filterSelect("transferSearch","transferSelect"));

    document.getElementById("btnAddStockConfirm").addEventListener("click", applyAddStock);
    document.getElementById("btnReduceConfirm").addEventListener("click", applyReduce);
    document.getElementById("btnTransferConfirm").addEventListener("click", applyTransfer);

    document.getElementById("btnAddStockCancel").addEventListener("click", ()=>{ document.getElementById("addStockForm").classList.add("hide"); });
    document.getElementById("btnReduceCancel").addEventListener("click", ()=>{ document.getElementById("reduceForm").classList.add("hide"); });
    document.getElementById("btnTransferCancel").addEventListener("click", ()=>{ document.getElementById("transferForm").classList.add("hide"); });

    document.getElementById("btnRescan").addEventListener("click", startScan);
    document.getElementById("btnConfirmScan").addEventListener("click", confirmScan);
    document.getElementById("btnCloseScan").addEventListener("click", closeScan);
    document.getElementById("dlgScan").addEventListener("close", stopScan);

    // Initial
    renderInv();
    populateSelect("addStockSelect"); populateSelect("reduceSelect"); populateSelect("transferSelect");
    renderDogs();
  });
})();
</script>

</body>
</html>
