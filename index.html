<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" data-go="Dogs">Dogs &amp; Pups</button>
      <button class="btn primary" data-go="Care">Care Timeline</button>
      <button class="btn primary" data-go="Feeding">Feeding</button>
      <button class="btn primary" data-go="InventoryMenu">Inventory</button>
      <button class="btn primary" data-go="Helpers">Helpers</button>
      <button class="btn primary" data-go="Records">Records &amp; Export</button>
    </div>
  </section>

  <!-- INVENTORY MENU -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>

    <div class="row">
      <button class="btn" data-back="Home">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="goal-grid">
      <button class="btn primary" data-go="InventoryAvailable">Inventory available</button>
      <button class="btn primary" data-go="InventoryAdd">Add to inventory</button>
      <button class="btn primary" data-go="InventoryTransfer">Transfer inventory</button>
    </div>
  </section>

  <!-- INVENTORY: AVAILABLE -->
  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>

    <div id="invAvailableMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="invAvailableList"></div>
    <div id="invAvailableArchived" class="hide"></div>
  </section>

  <!-- INVENTORY: ADD -->
  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin:10px 0;">
      This records item definition (what it is). Stock changes are handled later through Update.
    </div>

    <button class="btn primary" id="btnOpenAddDialog">+ Create item definition</button>

    <div class="muted small" style="margin-top:12px;">
      After saving, the item will appear under ‚ÄúInventory available‚Äù.
    </div>
  </section>

  <!-- INVENTORY: TRANSFER (next step) -->
  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>

    <div class="row">
      <button class="btn" data-back="InventoryMenu">Back</button>
      <button class="btn" data-home="Home">Home</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      Next step: wire scan ‚Üí match ‚Üí transfer update (destination + contact).
    </div>
  </section>

  <!-- OTHER MODULE PLACEHOLDERS -->
  <section id="viewDogs" class="card hide"><h2>Dogs &amp; Pups</h2></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2></section>
  <section id="viewFeeding" class="card hide"><h2>Feeding</h2></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2></section>
  <section id="viewRecords" class="card hide"><h2>Records &amp; Export</h2></section>

</main>

<button id="btnEmergency" class="btn danger emergency-fixed">Emergency</button>

<!-- ‚úÖ Definition-only Add/Edit dialog -->
<dialog id="dlgInv" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Inventory item</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>

    <div class="dlg-b">
      <label class="label">Item name / label</label>
      <input id="invName" />

      <div class="grid2">
        <div>
          <label class="label">Category</label>
          <select id="invCategory">
            <option>Food</option><option>Treat</option><option>Topper</option><option>Supplement</option>
            <option>Toy</option><option>Blanket</option><option>Coat</option><option>Equipment</option><option>Other</option>
          </select>
        </div>
        <div>
          <label class="label">Source</label>
          <select id="invSource">
            <option>Purchased</option><option>Donated</option><option>Other</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label class="label">Identifier type</label>
          <select id="invIdType"><option>None</option><option>Barcode</option><option>QR</option></select>
        </div>
        <div>
          <label class="label">Identifier value</label>
          <input id="invIdValue" placeholder="(scan or type)" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label class="label">Unit</label>
          <select id="invUnit"><option>count</option><option>weight</option><option>volume</option></select>
        </div>
        <div>
          <label class="label">Weight per unit (optional)</label>
          <input id="invWeightPerUnit" placeholder="e.g., 40 lb" />
        </div>
      </div>

      <label class="label">Notes (optional)</label>
      <input id="invNotes" />
    </div>

    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="btnSaveInv" value="ok">Save</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  const VIEWS = [
    "Home",
    "InventoryMenu",
    "InventoryAvailable",
    "InventoryAdd",
    "InventoryTransfer",
    "Dogs","Care","Feeding","Helpers","Records"
  ];

  function showView(name){
    VIEWS.forEach(v=>{
      const el = document.getElementById("view" + v);
      if(el) el.classList.toggle("hide", v !== name);
    });
    if(name === "InventoryAvailable"){
      renderInventoryAvailable();
    }
  }

  function bindNav(){
    document.querySelectorAll("[data-go]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView(btn.dataset.go));
    });
    document.querySelectorAll("[data-back]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView(btn.dataset.back));
    });
    document.querySelectorAll("[data-home]").forEach(btn=>{
      btn.addEventListener("click", ()=> showView("Home"));
    });
  }

  // ---- Inventory store (single stable key from now on) ----
  const INV_STORE_KEY = "breederPro_inventory_store_v1";

  function loadStore(){
    try{
      const raw = localStorage.getItem(INV_STORE_KEY);
      if(!raw) return { inventory: [] };
      const obj = JSON.parse(raw);
      if(!obj.inventory) obj.inventory = [];
      return obj;
    }catch{
      return { inventory: [] };
    }
  }
  function saveStore(obj){
    localStorage.setItem(INV_STORE_KEY, JSON.stringify(obj));
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function inventoryLow(it){
    const t = it.thresholdLow;
    if(t === null || t === undefined || t === "") return false;
    return Number(it.qty) <= Number(t);
  }

  function renderInventoryAvailable(){
    const meta = document.getElementById("invAvailableMeta");
    const list = document.getElementById("invAvailableList");
    const arch = document.getElementById("invAvailableArchived");

    const store = loadStore();
    const inv = store.inventory || [];

    const active = inv.filter(i=>!i.archived);
    const archived = inv.filter(i=>i.archived);

    meta.textContent = `Source: local inventory (v1). Active: ${active.length}. Archived: ${archived.length}.`;

    if(!active.length){
      list.innerHTML = `<div class="muted small">No active inventory items recorded.</div>`;
    } else {
      list.innerHTML = active.map(i=>{
        const low = inventoryLow(i);
        const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
        const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;

        const idLine = (i.identifierType && i.identifierType !== "None")
          ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
          : "Identifier: none";

        return `
          <div class="inv-item">
            <div class="inv-top">
              <div>
                <div class="inv-name ${low ? "low" : ""}">${escapeHtml(i.name||"(unnamed)")}</div>
                <div class="inv-meta">${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
                <div class="inv-meta">${idLine}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    if(!archived.length){
      arch.innerHTML = `<div class="muted small">No archived inventory items.</div>`;
    } else {
      arch.innerHTML = archived.map(i=>{
        const w = i.weightPerUnit ? ` ‚Ä¢ W/unit: ${escapeHtml(i.weightPerUnit)}` : "";
        const stock = `On hand: ${escapeHtml(String(i.qty ?? 0))}${(i.thresholdLow!==null && i.thresholdLow!=="" && i.thresholdLow!==undefined) ? ` ‚Ä¢ Low: ${escapeHtml(String(i.thresholdLow))}` : ""}`;

        const idLine = (i.identifierType && i.identifierType !== "None")
          ? `${escapeHtml(i.identifierType)}: ${escapeHtml(i.identifierValue||"")}`
          : "Identifier: none";

        return `
          <div class="inv-item">
            <div class="inv-top">
              <div>
                <div class="inv-name">${escapeHtml(i.name||"(unnamed)")}</div>
                <div class="inv-meta">Archived ‚Ä¢ ${escapeHtml(i.category||"")} ‚Ä¢ ${escapeHtml(i.source||"")} ‚Ä¢ ${escapeHtml(i.unit||"")} ‚Ä¢ ${stock}${w}</div>
                <div class="inv-meta">${idLine}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }
  }

  function bindInventoryAvailableButtons(){
    const refresh = document.getElementById("btnInvRefresh");
    const toggle = document.getElementById("btnInvToggleArchived");
    const arch = document.getElementById("invAvailableArchived");

    if(refresh) refresh.addEventListener("click", renderInventoryAvailable);

    if(toggle && arch){
      toggle.addEventListener("click", ()=> arch.classList.toggle("hide"));
    }
  }

  // ---- Add inventory wiring ----
  function openAddDialog(){
    // reset
    document.getElementById("invName").value = "";
    document.getElementById("invCategory").value = "Food";
    document.getElementById("invSource").value = "Other";
    document.getElementById("invIdType").value = "None";
    document.getElementById("invIdValue").value = "";
    document.getElementById("invUnit").value = "count";
    document.getElementById("invWeightPerUnit").value = "";
    document.getElementById("invNotes").value = "";

    document.getElementById("dlgInv").showModal();
  }

  function saveDefinition(){
    const name = (document.getElementById("invName").value || "").trim();
    if(!name){ alert("Item name is required."); return; }

    const store = loadStore();

    store.inventory.push({
      itemId: "inv_" + Date.now(),
      name,
      category: document.getElementById("invCategory").value,
      source: document.getElementById("invSource").value,
      identifierType: document.getElementById("invIdType").value,
      identifierValue: (document.getElementById("invIdValue").value || "").trim(),
      unit: document.getElementById("invUnit").value,
      weightPerUnit: (document.getElementById("invWeightPerUnit").value || "").trim(),
      notes: (document.getElementById("invNotes").value || "").trim(),
      qty: 0,
      thresholdLow: null,
      archived: false,
      createdAt: new Date().toISOString()
    });

    saveStore(store);
    document.getElementById("dlgInv").close();

    // after add, show available list so it‚Äôs visible immediately
    showView("InventoryAvailable");
    renderInventoryAvailable();
  }

  function bindAddPage(){
    document.getElementById("btnOpenAddDialog")?.addEventListener("click", openAddDialog);
    document.getElementById("btnSaveInv")?.addEventListener("click", (e)=>{
      e.preventDefault();
      saveDefinition();
    });
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    bindNav();
    bindInventoryAvailableButtons();
    bindAddPage();
    showView("Home");
  });
})();
</script>

</body>
</html>
