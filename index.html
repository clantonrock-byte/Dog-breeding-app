<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryMenu')">Inventory</button>
      <button class="btn primary" onclick="__go('Dogs')">Dogs &amp; Pups</button>
      <button class="btn primary" onclick="__go('Feeding')">Feeding</button>
      <button class="btn primary" onclick="__go('Care')">Care Timeline</button>
      <button class="btn primary" onclick="__go('Helpers')">Helpers</button>
      <button class="btn primary" onclick="__go('Records')">Records</button>
    </div>
  </section>

  <!-- DOGS LIST -->
  <section id="viewDogs" class="card hide">
    <h2>Dogs &amp; Pups</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnAddDog">+ Add dog</button>
      <button class="btn" id="btnToggleArchivedDogs">Show archived</button>
    </div>

    <div id="dogsActiveMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="dogsActiveList"></div>

    <div id="dogsArchivedWrap" class="hide" style="margin-top:14px;">
      <div class="muted small" id="dogsArchivedMeta"></div>
      <div id="dogsArchivedList"></div>
    </div>
  </section>

  <!-- DOG PROFILE -->
  <section id="viewDogProfile" class="card hide">
    <h2 id="dogProfileTitle">Dog Profile</h2>

    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div id="dogArchivedBanner" class="timeline-item hide" style="margin-top:12px;">
      <div><strong id="dogArchivedBannerText">Archived</strong></div>
      <div class="muted small" id="dogArchivedBannerMeta"></div>
    </div>

    <div class="timeline-item" style="margin-top:12px;">
      <div><strong>Photo</strong></div>
      <div class="muted small">Tap photo/placeholder to add or update (active). Archived is view-only.</div>

      <div id="dogPhotoTap" style="margin-top:10px; border:1px dashed #bbb; border-radius:12px; padding:12px; text-align:center;">
        <div id="dogPhotoPlaceholder" class="muted small">Tap to add photo</div>
        <img id="dogPhotoImg" alt="Dog photo" style="display:none; max-width:100%; border-radius:12px;" />
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnViewPhoto">View photo</button>
      </div>
    </div>

    <div class="timeline-item">
      <div><strong>Basics</strong></div>

      <label class="label">Call name (required)</label>
      <input id="dogCallName" />

      <label class="label">Registered name (optional)</label>
      <input id="dogRegisteredName" />

      <label class="label">Kennel name (optional)</label>
      <input id="dogKennelName" />

      <label class="label">Nicknames (optional)</label>
      <input id="dogNicknames" placeholder="Comma-separated" />

      <label class="label">Breed (default GSP)</label>
      <input id="dogBreed" />

      <div class="grid2">
        <div>
          <label class="label">Sex</label>
          <select id="dogSex">
            <option value="">(unknown)</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
        <div>
          <label class="label">DOB (optional)</label>
          <input id="dogDob" placeholder="YYYY-MM-DD" />
          <div class="muted small" style="margin-top:6px;">
            <label style="display:flex; gap:10px; align-items:center;">
              <input type="checkbox" id="dogDobEstimated" />
              Estimated DOB
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="timeline-item">
      <div><strong>ID &amp; Health</strong></div>

      <label class="label">Microchip ID (optional)</label>
      <input id="dogMicrochip" />

      <div style="margin-top:10px;">
        <div><strong>Rabies immunization</strong></div>
        <div class="muted small" id="dogRabiesSummary">No rabies record on file</div>
      </div>
    </div>

    <div class="timeline-item">
      <div><strong>Status</strong></div>

      <label class="label">Status</label>
      <select id="dogStatus">
        <option>Puppy</option>
        <option>Adult</option>
        <option>Retired</option>
        <option>Transferred</option>
        <option>Deceased</option>
      </select>

      <div id="statusNoteWrap" class="hide" style="margin-top:10px;">
        <label class="label">Status note (required for Transferred / Deceased)</label>
        <input id="dogStatusNote" placeholder="Short factual note" />
      </div>

      <div class="muted small" id="dogStatusTimestamps" style="margin-top:8px;"></div>
    </div>

    <div class="timeline-item">
      <div><strong>Notes</strong></div>
      <div class="muted small">Notes remain editable even when archived.</div>
      <textarea id="dogNotes" rows="5" style="width:100%; margin-top:8px;"></textarea>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnSaveDog">Save</button>
        <button class="btn" id="btnCancelDog">Cancel</button>
      </div>

      <div class="muted small" id="dogSaveStatus" style="margin-top:10px;"></div>
    </div>
  </section>

  <!-- INVENTORY MENU -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryAvailable')">Inventory available</button>
      <button class="btn primary" onclick="__go('InventoryAdd')">Add to inventory</button>
      <button class="btn primary" onclick="__go('InventoryAddStock')">Add stock</button>
      <button class="btn primary" onclick="__go('InventoryReduceStock')">Reduce stock</button>
      <button class="btn primary" onclick="__go('InventoryTransfer')">Transfer inventory</button>
    </div>
  </section>

  <!-- INVENTORY AVAILABLE -->
  <section id="viewInventoryAvailable" class="card hide">
    <h2>Inventory available</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="btnInvRefresh">Refresh list</button>
      <button class="btn" id="btnInvToggleArchived">Show archived</button>
    </div>

    <div id="invMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="invList"></div>
    <div id="invArchived" class="hide"></div>
  </section>

  <!-- ADD INVENTORY -->
  <section id="viewInventoryAdd" class="card hide">
    <h2>Add to inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnOpenAddDialog">+ Create item definition</button>
      <button class="btn" id="btnScanForAdd">Scan now (QR or barcode)</button>
    </div>
  </section>

  <!-- ADD STOCK -->
  <section id="viewInventoryAddStock" class="card hide">
    <h2>Add stock</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanAddStock">Scan item</button>
      <button class="btn" id="btnAddStockRefresh">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="addStockSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="addStockSelect"></select>

    <div id="addStockForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="addStockItemName"></strong></div>
        <div class="muted small" id="addStockItemMeta"></div>
      </div>

      <label class="label">Quantity to add</label>
      <input id="addStockQty" inputmode="decimal" placeholder="e.g., 5" />

      <label class="label">Note (optional)</label>
      <input id="addStockNote" placeholder="delivery / donation" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnAddStockConfirm">Confirm add</button>
        <button class="btn" id="btnAddStockCancel">Cancel</button>
      </div>
    </div>

    <div id="addStockStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- REDUCE STOCK -->
  <section id="viewInventoryReduceStock" class="card hide">
    <h2>Reduce stock</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanReduce">Scan item</button>
      <button class="btn" id="btnReduceRefresh">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="reduceSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="reduceSelect"></select>

    <div id="reduceForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="reduceItemName"></strong></div>
        <div class="muted small" id="reduceItemMeta"></div>
      </div>

      <label class="label">Action</label>
      <select id="reduceAction">
        <option>Used</option>
        <option>Discarded</option>
      </select>

      <label class="label">Quantity</label>
      <input id="reduceQty" inputmode="decimal" placeholder="e.g., 2" />

      <label class="label">Note (optional)</label>
      <input id="reduceNote" placeholder="fed / damaged / spoiled" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnReduceConfirm">Confirm</button>
        <button class="btn" id="btnReduceCancel">Cancel</button>
      </div>
    </div>

    <div id="reduceStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- TRANSFER -->
  <section id="viewInventoryTransfer" class="card hide">
    <h2>Transfer inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnScanTransfer">Scan item</button>
      <button class="btn" id="btnTransferRefresh">Refresh list</button>
    </div>

    <label class="label">Search (optional)</label>
    <input id="transferSearch" placeholder="Type to filter‚Ä¶" />

    <label class="label">Select item</label>
    <select id="transferSelect"></select>

    <div id="transferForm" class="hide" style="margin-top:12px;">
      <div class="timeline-item">
        <div><strong id="transferItemName"></strong></div>
        <div class="muted small" id="transferItemMeta"></div>
      </div>

      <label class="label">Quantity</label>
      <input id="transferQty" inputmode="decimal" placeholder="e.g., 1" />

      <label class="label">Destination</label>
      <select id="transferType">
        <option>With a dog</option>
        <option>To adopter</option>
        <option>To foster</option>
        <option>To another organization</option>
        <option>Moved to storage</option>
        <option>Other</option>
      </select>

      <label class="label">Note (optional)</label>
      <input id="transferNote" placeholder="Any factual notes" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnTransferConfirm">Confirm transfer</button>
        <button class="btn" id="btnTransferCancel">Cancel</button>
      </div>
    </div>

    <div id="transferStatus" class="muted small" style="margin-top:10px;"></div>
  </section>

  <!-- OTHER PAGES -->
  <section id="viewFeeding" class="card hide"><h2>Feeding</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewRecords" class="card hide"><h2>Records</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>

</main>

<!-- Photo choice dialog -->
<dialog id="dlgPhotoChoice" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Set current photo</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btn primary" id="btnTakePhoto">Take photo</button>
        <button type="button" class="btn" id="btnChoosePhoto">Choose from gallery</button>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
<input id="fileGallery" type="file" accept="image/*" style="display:none;" />

<!-- Add inventory dialog -->
<dialog id="dlgInv" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Inventory item</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <label class="label">Item name</label>
      <input id="invName" />

      <label class="label">Category</label>
      <select id="invCategory">
        <option>Food</option><option>Treat</option><option>Toy</option><option>Blanket</option><option>Equipment</option><option>Other</option>
      </select>

      <label class="label">Source</label>
      <select id="invSource"><option>Purchased</option><option>Donated</option><option>Other</option></select>

      <label class="label">Identifier type</label>
      <select id="invIdType"><option>None</option><option>Barcode</option><option>QR</option></select>

      <label class="label">Identifier value</label>
      <input id="invIdValue" />

      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" id="btnScanInsideAdd">Scan now (QR or barcode)</button>
        <button type="button" class="btn" id="btnDeleteId">Delete now</button>
      </div>

      <label class="label">Unit</label>
      <select id="invUnit"><option>count</option><option>weight</option><option>volume</option></select>

      <label class="label">Notes</label>
      <input id="invNotes" />
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="btnSaveInv" value="ok">Save</button>
    </div>
  </form>
</dialog>

<!-- Scan dialog -->
<dialog id="dlgScan" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Scan</h3>
      <button class="info-btn" value="cancel" aria-label="Close" id="btnCloseScan">‚úï</button>
    </div>
    <div class="dlg-b">
      <video id="scanVideo" playsinline autoplay muted></video>
      <div id="scanResultBox" class="scan-result hide">
        <div class="muted small">Identifier captured</div>
        <div id="scanValue" class="scan-value"></div>
      </div>
      <div id="scanHelp" class="muted small" style="margin-top:10px;"></div>
      <label class="label" style="margin-top:12px;">Manual entry</label>
      <input id="scanManual" />
    </div>
    <div class="dlg-f">
      <button type="button" class="btn" id="btnRescan">Rescan</button>
      <button type="button" class="btn primary" id="btnConfirmScan">Confirm</button>
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<script>
/* =========================
   SELF-CONTAINED NAV STACK
   ========================= */
(function(){
  const VIEWS = [
    "Home",
    "InventoryMenu","InventoryAvailable","InventoryAdd","InventoryAddStock","InventoryReduceStock","InventoryTransfer",
    "Dogs","DogProfile","Feeding","Care","Helpers","Records"
  ];
  let current="Home";
  const stack=[];

  function show(name){
    VIEWS.forEach(v=>{
      const el=document.getElementById("view"+v);
      if(el) el.classList.toggle("hide", v!==name);
    });
    current=name;
    if(typeof window.__afterShow==="function"){
      try{ window.__afterShow(name);}catch(_){}
    }
  }

  window.__go=function(name){
    if(!name || name===current) return;
    stack.push(current);
    show(name);
  };
  window.__back=function(){
    if(stack.length===0) return show("Home");
    show(stack.pop());
  };
  window.__home=function(){
    stack.length=0;
    show("Home");
  };

  document.addEventListener("DOMContentLoaded", ()=> show("Home"));
})();
</script>

<script>
/* =========================
   APP LOGIC (DOGS + INVENTORY + SCAN)
   ========================= */
(function(){
  const INV_KEY="breederPro_inventory_store_v1";
  const DOG_KEY="breederPro_dogs_store_v1";

  const nowISO=()=>new Date().toISOString();
  const fmt=(ts)=>{ try{return new Date(ts).toLocaleString();}catch{return "";} };
  const setText=(id,msg)=>{ const el=document.getElementById(id); if(el) el.textContent=msg||""; };

  // ---------- Storage ----------
  function loadInv(){ try{ const raw=localStorage.getItem(INV_KEY); if(!raw) return {inventory:[]}; const o=JSON.parse(raw); if(!Array.isArray(o.inventory)) o.inventory=[]; return o; } catch{ return {inventory:[]}; } }
  function saveInv(o){ localStorage.setItem(INV_KEY, JSON.stringify(o)); }
  function loadDogs(){ try{ const raw=localStorage.getItem(DOG_KEY); if(!raw) return {dogs:[]}; const o=JSON.parse(raw); if(!Array.isArray(o.dogs)) o.dogs=[]; return o; } catch{ return {dogs:[]}; } }
  function saveDogs(o){ localStorage.setItem(DOG_KEY, JSON.stringify(o)); }

  const invActive=()=>loadInv().inventory.filter(i=>!i.archived);
  const dogStore=()=>loadDogs();

  // ---------- Inventory UI ----------
  function populateInvSelect(selectId){
    const sel=document.getElementById(selectId);
    if(!sel) return;
    const items=invActive();
    sel.innerHTML="";
    const o0=document.createElement("option"); o0.value=""; o0.textContent="Select item‚Ä¶"; sel.appendChild(o0);
    items.forEach(i=>{
      const opt=document.createElement("option");
      opt.value=i.itemId;
      opt.textContent=`${i.name} (on hand: ${Number(i.qty||0)})`;
      sel.appendChild(opt);
    });
  }

  function filterInvSelect(searchId, selectId){
    const q=(document.getElementById(searchId)?.value||"").trim().toLowerCase();
    const sel=document.getElementById(selectId);
    if(!sel) return;

    const items=invActive().filter(i=>{
      if(!q) return true;
      const hay=`${i.name||""} ${i.category||""} ${i.source||""} ${i.identifierValue||""}`.toLowerCase();
      return hay.includes(q);
    });

    sel.innerHTML="";
    const o0=document.createElement("option"); o0.value=""; o0.textContent="Select item‚Ä¶"; sel.appendChild(o0);
    items.forEach(i=>{
      const opt=document.createElement("option");
      opt.value=i.itemId;
      opt.textContent=`${i.name} (on hand: ${Number(i.qty||0)})`;
      sel.appendChild(opt);
    });
  }

  function renderInvAvailable(){
    const store=loadInv();
    const items=store.inventory.filter(i=>!i.archived);
    const archived=store.inventory.filter(i=>i.archived);

    const meta=document.getElementById("invMeta");
    const list=document.getElementById("invList");
    const arch=document.getElementById("invArchived");

    if(meta) meta.textContent=`Active: ${items.length}. Archived: ${archived.length}.`;

    if(list){
      list.innerHTML = items.length ? items.map(i=>`
        <div class="timeline-item">
          <div><strong>${i.name}</strong></div>
          <div class="muted small">On hand: ${Number(i.qty||0)} ‚Ä¢ ${i.identifierType!=="None" ? (i.identifierType+": "+(i.identifierValue||"")) : "Identifier: none"}</div>
        </div>
      `).join("") : `<div class="muted small">No active items.</div>`;
    }

    if(arch){
      arch.innerHTML = archived.length ? archived.map(i=>`
        <div class="timeline-item">
          <div><strong>${i.name}</strong></div>
          <div class="muted small">Archived ‚Ä¢ On hand: ${Number(i.qty||0)}</div>
        </div>
      `).join("") : `<div class="muted small">No archived items.</div>`;
    }
  }

  // ---------- Inventory actions ----------
  let addStockItemId=null, reduceItemId=null, transferItemId=null;

  function showAddStockForm(itemId){
    const it=invActive().find(x=>x.itemId===itemId);
    if(!it){ setText("addStockStatus","Item not found."); return; }
    addStockItemId=itemId;
    document.getElementById("addStockForm").classList.remove("hide");
    document.getElementById("addStockItemName").textContent=it.name;
    document.getElementById("addStockItemMeta").textContent=`On hand: ${Number(it.qty||0)}`;
    document.getElementById("addStockQty").value="1";
    setText("addStockStatus","");
  }

  function showReduceForm(itemId){
    const it=invActive().find(x=>x.itemId===itemId);
    if(!it){ setText("reduceStatus","Item not found."); return; }
    reduceItemId=itemId;
    document.getElementById("reduceForm").classList.remove("hide");
    document.getElementById("reduceItemName").textContent=it.name;
    document.getElementById("reduceItemMeta").textContent=`On hand: ${Number(it.qty||0)}`;
    document.getElementById("reduceQty").value="1";
    setText("reduceStatus","");
  }

  function showTransferForm(itemId){
    const it=invActive().find(x=>x.itemId===itemId);
    if(!it){ setText("transferStatus","Item not found."); return; }
    transferItemId=itemId;
    document.getElementById("transferForm").classList.remove("hide");
    document.getElementById("transferItemName").textContent=it.name;
    document.getElementById("transferItemMeta").textContent=`On hand: ${Number(it.qty||0)}`;
    document.getElementById("transferQty").value="1";
    setText("transferStatus","");
  }

  function applyAddStock(){
    const qty=Math.abs(Number(document.getElementById("addStockQty").value||"0")||0);
    if(!addStockItemId || qty<=0){ setText("addStockStatus","Pick item + qty"); return; }
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===addStockItemId);
    if(!it){ setText("addStockStatus","Item not found."); return; }
    it.qty=Number(it.qty||0)+qty;
    saveInv(store);
    setText("addStockStatus","Added.");
    renderInvAvailable();
    populateInvSelect("addStockSelect");
  }

  function applyReduce(){
    const qty=Math.abs(Number(document.getElementById("reduceQty").value||"0")||0);
    if(!reduceItemId || qty<=0){ setText("reduceStatus","Pick item + qty"); return; }
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===reduceItemId);
    if(!it){ setText("reduceStatus","Item not found."); return; }
    it.qty=Math.max(0, Number(it.qty||0)-qty);
    saveInv(store);
    setText("reduceStatus","Recorded.");
    renderInvAvailable();
    populateInvSelect("reduceSelect");
  }

  function applyTransfer(){
    const qty=Math.abs(Number(document.getElementById("transferQty").value||"0")||0);
    if(!transferItemId || qty<=0){ setText("transferStatus","Pick item + qty"); return; }
    const store=loadInv();
    const it=store.inventory.find(x=>x.itemId===transferItemId);
    if(!it){ setText("transferStatus","Item not found."); return; }
    it.qty=Math.max(0, Number(it.qty||0)-qty);
    saveInv(store);
    setText("transferStatus","Transferred.");
    renderInvAvailable();
    populateInvSelect("transferSelect");
  }

  // ---------- Add inventory definition ----------
  function openInvDialog(){
    document.getElementById("invName").value="";
    document.getElementById("invCategory").value="Food";
    document.getElementById("invSource").value="Other";
    document.getElementById("invIdType").value="Barcode";
    document.getElementById("invIdValue").value="";
    document.getElementById("invUnit").value="count";
    document.getElementById("invNotes").value="";
    document.getElementById("dlgInv").showModal();
  }

  function saveInvDefinition(){
    const name=(document.getElementById("invName").value||"").trim();
    if(!name){ alert("Item name required."); return; }
    const store=loadInv();
    store.inventory.push({
      itemId:"inv_"+Date.now()+"_"+Math.random().toString(16).slice(2),
      name,
      category:document.getElementById("invCategory").value,
      source:document.getElementById("invSource").value,
      identifierType:document.getElementById("invIdType").value,
      identifierValue:(document.getElementById("invIdValue").value||"").trim(),
      unit:document.getElementById("invUnit").value,
      notes:(document.getElementById("invNotes").value||"").trim(),
      qty:0,
      archived:false
    });
    saveInv(store);
    document.getElementById("dlgInv").close();
    renderInvAvailable();
    populateInvSelect("addStockSelect");
    populateInvSelect("reduceSelect");
    populateInvSelect("transferSelect");
  }

  // ---------- Dogs ----------
  let currentDogId=null;

  function addDog(callName){
    const store=dogStore();
    const dogId="dog_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    store.dogs.push({
      dogId,
      callName,
      registeredName:"",
      kennelName:"",
      nicknames:[],
      breed:"German Shorthaired Pointer",
      sex:"",
      dob:"",
      dobEstimated:false,
      microchip:"",
      rabiesLastDate:null,
      status:"Adult",
      statusChangedAt: nowISO(),
      archived:false,
      archivedAt:null,
      statusNote:"",
      notes:"",
      photoDataUrl:""
    });
    saveDogs(store);
    renderDogs();
  }

  function renderDogs(){
    const store=dogStore();
    const active=store.dogs.filter(d=>!d.archived);
    const archived=store.dogs.filter(d=>d.archived);

    const activeMeta=document.getElementById("dogsActiveMeta");
    const activeList=document.getElementById("dogsActiveList");
    const archWrap=document.getElementById("dogsArchivedWrap");
    const archMeta=document.getElementById("dogsArchivedMeta");
    const archList=document.getElementById("dogsArchivedList");

    if(activeMeta) activeMeta.textContent=`Active dogs: ${active.length}`;

    if(activeList){
      activeList.innerHTML = active.length ? active.map(d=>`
        <div class="timeline-item">
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div>
              <div><strong>${d.callName}</strong></div>
              <div class="muted small">Status: ${d.status}</div>
            </div>
            <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
          </div>
        </div>
      `).join("") : `<div class="muted small">No active dogs yet.</div>`;
    }

    if(!archWrap.classList.contains("hide")){
      if(archMeta) archMeta.textContent=`Archived dogs: ${archived.length}`;
      if(archList){
        archList.innerHTML = archived.length ? archived.map(d=>`
          <div class="timeline-item">
            <div class="row" style="justify-content:space-between; gap:10px;">
              <div>
                <div><strong>${d.callName}</strong></div>
                <div class="muted small">Archived ‚Äî ${d.status} ‚Ä¢ ${d.archivedAt ? fmt(d.archivedAt) : ""}</div>
              </div>
              <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
            </div>
          </div>
        `).join("") : `<div class="muted small">No archived dogs.</div>`;
      }
    }
  }

  function getDog(id){
    const store=dogStore();
    return store.dogs.find(d=>d.dogId===id) || null;
  }

  function setDogReadOnly(arch){
    const lockIds=[
      "dogCallName","dogRegisteredName","dogKennelName","dogNicknames","dogBreed",
      "dogSex","dogDob","dogMicrochip","dogStatus","dogStatusNote","dogDobEstimated"
    ];
    lockIds.forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.disabled=arch;
    });
    document.getElementById("dogNotes").disabled=false;
    document.getElementById("btnSaveDog").textContent = arch ? "Save notes" : "Save";
  }

  function renderDogProfile(d){
    currentDogId=d.dogId;
    document.getElementById("dogProfileTitle").textContent=d.callName||"Dog Profile";

    const banner=document.getElementById("dogArchivedBanner");
    if(d.archived){
      banner.classList.remove("hide");
      document.getElementById("dogArchivedBannerText").textContent=`Archived ‚Äî ${d.status}`;
      document.getElementById("dogArchivedBannerMeta").textContent=d.archivedAt?`Archived at: ${fmt(d.archivedAt)}`:"";
    } else {
      banner.classList.add("hide");
    }

    const img=document.getElementById("dogPhotoImg");
    const ph=document.getElementById("dogPhotoPlaceholder");
    if(d.photoDataUrl){
      img.src=d.photoDataUrl;
      img.style.display="block";
      ph.style.display="none";
    } else {
      img.src="";
      img.style.display="none";
      ph.style.display="block";
    }

    document.getElementById("btnViewPhoto").disabled=!d.photoDataUrl;

    document.getElementById("dogCallName").value=d.callName||"";
    document.getElementById("dogRegisteredName").value=d.registeredName||"";
    document.getElementById("dogKennelName").value=d.kennelName||"";
    document.getElementById("dogNicknames").value=(d.nicknames||[]).join(", ");
    document.getElementById("dogBreed").value=d.breed||"German Shorthaired Pointer";
    document.getElementById("dogSex").value=d.sex||"";
    document.getElementById("dogDob").value=d.dob||"";
    document.getElementById("dogDobEstimated").checked=!!d.dobEstimated;
    document.getElementById("dogMicrochip").value=d.microchip||"";
    document.getElementById("dogRabiesSummary").textContent=d.rabiesLastDate?`Last recorded: ${d.rabiesLastDate}`:"No rabies record on file";

    document.getElementById("dogStatus").value=d.status||"Adult";
    document.getElementById("dogStatusNote").value=d.statusNote||"";
    document.getElementById("dogNotes").value=d.notes||"";

    const st=document.getElementById("dogStatus").value;
    const wrap=document.getElementById("statusNoteWrap");
    if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide"); else wrap.classList.add("hide");

    const ts=[];
    if(d.statusChangedAt) ts.push(`Status set: ${fmt(d.statusChangedAt)}`);
    if(d.archivedAt) ts.push(`Archived: ${fmt(d.archivedAt)}`);
    document.getElementById("dogStatusTimestamps").textContent=ts.join(" ‚Ä¢ ");

    setDogReadOnly(!!d.archived);
    setText("dogSaveStatus","");
  }

  window.__openDog=function(id){
    const d=getDog(id);
    if(!d) return;
    __go("DogProfile");
    renderDogProfile(d);
  };

  function saveDogProfile(){
    const store=dogStore();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;

    d.notes=(document.getElementById("dogNotes").value||"").trim();

    if(d.archived){
      saveDogs(store);
      setText("dogSaveStatus","Saved notes.");
      return;
    }

    d.callName=(document.getElementById("dogCallName").value||"").trim()||d.callName;
    d.registeredName=(document.getElementById("dogRegisteredName").value||"").trim();
    d.kennelName=(document.getElementById("dogKennelName").value||"").trim();
    d.nicknames=(document.getElementById("dogNicknames").value||"").split(",").map(s=>s.trim()).filter(Boolean);
    d.breed=(document.getElementById("dogBreed").value||"").trim()||"German Shorthaired Pointer";
    d.sex=document.getElementById("dogSex").value||"";
    d.dob=(document.getElementById("dogDob").value||"").trim();
    d.dobEstimated=!!document.getElementById("dogDobEstimated").checked;
    d.microchip=(document.getElementById("dogMicrochip").value||"").trim();

    const newStatus=document.getElementById("dogStatus").value;
    if(newStatus!==d.status){
      d.status=newStatus;
      d.statusChangedAt=nowISO();
    }

    if(newStatus==="Transferred"||newStatus==="Deceased"){
      const note=(document.getElementById("dogStatusNote").value||"").trim();
      if(!note){
        setText("dogSaveStatus","Status note required.");
        alert("Status note is required for Transferred/Deceased.");
        return;
      }
      d.statusNote=note;
      d.archived=true;
      d.archivedAt=nowISO();
    } else {
      d.archived=false;
      d.archivedAt=null;
      d.statusNote=(document.getElementById("dogStatusNote").value||"").trim();
    }

    saveDogs(store);
    setText("dogSaveStatus","Saved.");
    renderDogs();
    renderDogProfile(d);
  }

  // ---------- Photo ----------
  async function compressImageToDataUrl(file){
    const dataUrl = await new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
    const img=new Image();
    img.src=dataUrl;
    await new Promise(res=>img.onload=res);

    const maxEdge=900;
    const scale=Math.min(1, maxEdge/Math.max(img.width,img.height));
    const w=Math.max(1, Math.round(img.width*scale));
    const h=Math.max(1, Math.round(img.height*scale));

    const c=document.createElement("canvas");
    c.width=w; c.height=h;
    c.getContext("2d").drawImage(img,0,0,w,h);
    return c.toDataURL("image/jpeg",0.78);
  }

  async function setDogPhotoFromFile(file){
    const store=dogStore();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;
    if(d.archived){ alert("Archived dogs are view-only."); return; }
    d.photoDataUrl=await compressImageToDataUrl(file);
    saveDogs(store);
    renderDogs();
    renderDogProfile(d);
  }

  function openPhotoChoice(){
    const d=getDog(currentDogId);
    if(!d || d.archived) return;
    document.getElementById("dlgPhotoChoice").showModal();
  }

  // ---------- Scan ----------
  let scanStream=null, lastScanValue="", scanContext="transfer";

  function stopScanStream(){
    const video=document.getElementById("scanVideo");
    if(video) video.pause();
    if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  }

  async function startScan(){
    const video=document.getElementById("scanVideo");
    const help=document.getElementById("scanHelp");
    const box=document.getElementById("scanResultBox");
    const val=document.getElementById("scanValue");

    lastScanValue=""; box.classList.add("hide"); val.textContent=""; help.textContent="";
    try{
      scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
      video.srcObject=scanStream;
      video.setAttribute("playsinline","");
      video.muted=true; video.autoplay=true;
      try{ await video.play(); }catch{ setTimeout(()=>{ video.play().catch(()=>{}); },250); }
    }catch{
      help.textContent="Camera unavailable. Manual entry works.";
      return;
    }

    if(!("BarcodeDetector" in window)){
      help.textContent="Scanner unsupported. Manual entry works.";
      return;
    }

    let detector;
    try{ detector=new BarcodeDetector({formats:["qr_code","code_128","ean_13","ean_8","upc_a","upc_e"]}); }
    catch{ detector=new BarcodeDetector(); }

    help.textContent="Point camera at code. Confirm is required.";

    const loop=async()=>{
      if(!scanStream) return;
      try{
        const codes=await detector.detect(video);
        if(codes && codes.length){
          const raw=codes[0].rawValue||"";
          if(raw){
            lastScanValue=raw;
            box.classList.remove("hide");
            val.textContent=raw;
            stopScanStream();
            return;
          }
        }
      }catch{}
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  function openScanDialog(context){
    scanContext=context||"transfer";
    document.getElementById("scanManual").value="";
    document.getElementById("dlgScan").showModal();
    startScan();
  }

  function closeScanDialog(){
    stopScanStream();
    document.getElementById("dlgScan").close();
  }

  function findMatch(code){
    const c=String(code||"").trim();
    const store=loadInv();
    return store.inventory.find(i =>
      (i.identifierType==="Barcode"||i.identifierType==="QR") &&
      String(i.identifierValue||"").trim()===c
    ) || null;
  }

  function confirmScan(){
    const manual=(document.getElementById("scanManual").value||"").trim();
    const code=(lastScanValue && lastScanValue.trim()) ? lastScanValue.trim() : manual;

    if(!code){
      document.getElementById("scanHelp").textContent="No code captured. Manual entry works.";
      return;
    }

    if(scanContext==="add"){
      document.getElementById("invIdType").value="Barcode";
      document.getElementById("invIdValue").value=code;
      closeScanDialog();
      return;
    }

    const match=findMatch(code);
    closeScanDialog();

    if(!match){
      if(scanContext==="addstock") setText("addStockStatus","No match found. Create definition first.");
      else if(scanContext==="reduce") setText("reduceStatus","No match found. Create definition first.");
      else setText("transferStatus","No match found. Create definition first.");
      return;
    }

    if(scanContext==="addstock") showAddStockForm(match.itemId);
    else if(scanContext==="reduce") showReduceForm(match.itemId);
    else showTransferForm(match.itemId);
  }

  // ---------- afterShow ----------
  window.__afterShow=function(view){
    if(view==="Dogs") renderDogs();
    if(view==="InventoryAvailable") renderInvAvailable();
    if(view==="InventoryAddStock") populateInvSelect("addStockSelect");
    if(view==="InventoryReduceStock") populateInvSelect("reduceSelect");
    if(view==="InventoryTransfer") populateInvSelect("transferSelect");
    if(view==="DogProfile"){
      const d=getDog(currentDogId);
      if(d) renderDogProfile(d);
    }
  };

  // ---------- Bind ----------
  document.addEventListener("DOMContentLoaded", ()=>{
    // Dogs
    document.getElementById("btnAddDog").addEventListener("click", ()=>{
      const name = prompt("Call name (required):");
      if(!name) return;
      addDog(name.trim());
    });

    document.getElementById("btnToggleArchivedDogs").addEventListener("click", ()=>{
      document.getElementById("dogsArchivedWrap").classList.toggle("hide");
      renderDogs();
    });

    document.getElementById("dogPhotoTap").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(!d) return;
      if(d.archived){
        if(d.photoDataUrl) window.open(d.photoDataUrl,"_blank");
        return;
      }
      openPhotoChoice();
    });

    document.getElementById("btnViewPhoto").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(d?.photoDataUrl) window.open(d.photoDataUrl,"_blank");
    });

    document.getElementById("btnTakePhoto").addEventListener("click", ()=>document.getElementById("fileCamera").click());
    document.getElementById("btnChoosePhoto").addEventListener("click", ()=>document.getElementById("fileGallery").click());

    document.getElementById("fileCamera").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhotoFromFile(f);
      document.getElementById("dlgPhotoChoice").close();
    });

    document.getElementById("fileGallery").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhotoFromFile(f);
      document.getElementById("dlgPhotoChoice").close();
    });

    document.getElementById("dogStatus").addEventListener("change", ()=>{
      const st=document.getElementById("dogStatus").value;
      const wrap=document.getElementById("statusNoteWrap");
      if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide");
      else wrap.classList.add("hide");
    });

    document.getElementById("btnSaveDog").addEventListener("click", saveDogProfile);
    document.getElementById("btnCancelDog").addEventListener("click", ()=>{ setText("dogSaveStatus",""); __back(); });

    // Inventory
    document.getElementById("btnInvRefresh").addEventListener("click", renderInvAvailable);
    document.getElementById("btnInvToggleArchived").addEventListener("click", ()=>document.getElementById("invArchived").classList.toggle("hide"));

    document.getElementById("btnOpenAddDialog").addEventListener("click", openInvDialog);
    document.getElementById("btnSaveInv").addEventListener("click", (e)=>{ e.preventDefault(); saveInvDefinition(); });
    document.getElementById("btnDeleteId").addEventListener("click", ()=>{ document.getElementById("invIdValue").value=""; });

    // Scan openers
    document.getElementById("btnScanForAdd").addEventListener("click", ()=>openScanDialog("add"));
    document.getElementById("btnScanInsideAdd").addEventListener("click", ()=>openScanDialog("add"));
    document.getElementById("btnScanAddStock").addEventListener("click", ()=>openScanDialog("addstock"));
    document.getElementById("btnScanReduce").addEventListener("click", ()=>openScanDialog("reduce"));
    document.getElementById("btnScanTransfer").addEventListener("click", ()=>openScanDialog("transfer"));

    // Lists/refresh
    document.getElementById("btnAddStockRefresh").addEventListener("click", ()=>populateInvSelect("addStockSelect"));
    document.getElementById("btnReduceRefresh").addEventListener("click", ()=>populateInvSelect("reduceSelect"));
    document.getElementById("btnTransferRefresh").addEventListener("click", ()=>populateInvSelect("transferSelect"));

    document.getElementById("addStockSelect").addEventListener("change", (e)=>{ if(e.target.value) showAddStockForm(e.target.value); });
    document.getElementById("reduceSelect").addEventListener("change", (e)=>{ if(e.target.value) showReduceForm(e.target.value); });
    document.getElementById("transferSelect").addEventListener("change", (e)=>{ if(e.target.value) showTransferForm(e.target.value); });

    document.getElementById("addStockSearch").addEventListener("input", ()=>filterInvSelect("addStockSearch","addStockSelect"));
    document.getElementById("reduceSearch").addEventListener("input", ()=>filterInvSelect("reduceSearch","reduceSelect"));
    document.getElementById("transferSearch").addEventListener("input", ()=>filterInvSelect("transferSearch","transferSelect"));

    document.getElementById("btnAddStockConfirm").addEventListener("click", applyAddStock);
    document.getElementById("btnReduceConfirm").addEventListener("click", applyReduce);
    document.getElementById("btnTransferConfirm").addEventListener("click", applyTransfer);

    document.getElementById("btnAddStockCancel").addEventListener("click", ()=>{ document.getElementById("addStockForm").classList.add("hide"); setText("addStockStatus",""); });
    document.getElementById("btnReduceCancel").addEventListener("click", ()=>{ document.getElementById("reduceForm").classList.add("hide"); setText("reduceStatus",""); });
    document.getElementById("btnTransferCancel").addEventListener("click", ()=>{ document.getElementById("transferForm").classList.add("hide"); setText("transferStatus",""); });

    // Scan dialog
    document.getElementById("btnRescan").addEventListener("click", startScan);
    document.getElementById("btnConfirmScan").addEventListener("click", confirmScan);
    document.getElementById("btnCloseScan").addEventListener("click", closeScanDialog);
    document.getElementById("dlgScan").addEventListener("close", stopScanStream);

    // Talk
    document.getElementById("btnTalk").addEventListener("click", ()=>alert("Voice may be used at any time."));

    // Initial renders
    renderInvAvailable();
    populateInvSelect("addStockSelect");
    populateInvSelect("reduceSelect");
    populateInvSelect("transferSelect");
    renderDogs();
  });
})();
</script>

</body>
</html>
