<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breeder Pro</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ‚úÖ NAV defined immediately -->
  <script>
    (function () {
      const VIEWS = [
        "Home",
        "InventoryMenu","InventoryAvailable","InventoryAdd","InventoryAddStock","InventoryReduceStock","InventoryTransfer",
        "Dogs","DogProfile",
        "Feeding","Care","Helpers","Records"
      ];
      let current = "Home";
      const stack = [];
      const queue = [];

      function show(name){
        VIEWS.forEach(v=>{
          const el=document.getElementById("view"+v);
          if(el) el.classList.toggle("hide", v !== name);
        });
        current = name;
        if(typeof window.__afterShow === "function"){
          try{ window.__afterShow(name); }catch(_){}
        }
      }

      window.__go = function(name){
        if(!name) return;
        if(!document.getElementById("viewHome")) return queue.push({t:"go", name});
        if(name === current) return;
        stack.push(current);
        show(name);
      };
      window.__back = function(){
        if(!document.getElementById("viewHome")) return queue.push({t:"back"});
        if(stack.length === 0) return show("Home");
        show(stack.pop());
      };
      window.__home = function(){
        if(!document.getElementById("viewHome")) return queue.push({t:"home"});
        stack.length = 0;
        show("Home");
      };
      window.__navReady = function(){
        while(queue.length){
          const a=queue.shift();
          if(a.t==="go") window.__go(a.name);
          if(a.t==="back") window.__back();
          if(a.t==="home") window.__home();
        }
      };

      document.addEventListener("DOMContentLoaded", ()=>{
        show("Home");
        window.__navReady();
      });
    })();
  </script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="brand-title">Breeder Pro</div>
    <div class="brand-sub">Phase 1</div>
  </div>
  <div class="top-actions">
    <button id="btnTalk" class="btn">üéôÔ∏è Talk</button>
  </div>
</header>

<main class="shell">

  <!-- HOME -->
  <section id="viewHome" class="card">
    <h2>What is our goal today?</h2>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryMenu')">Inventory</button>
      <button class="btn primary" onclick="__go('Dogs')">Dogs &amp; Pups</button>
      <button class="btn primary" onclick="__go('Feeding')">Feeding</button>
      <button class="btn primary" onclick="__go('Care')">Care Timeline</button>
      <button class="btn primary" onclick="__go('Helpers')">Helpers</button>
      <button class="btn primary" onclick="__go('Records')">Records</button>
    </div>
  </section>

  <!-- DOGS LIST -->
  <section id="viewDogs" class="card hide">
    <h2>Dogs &amp; Pups</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnAddDog">+ Add dog</button>
      <button class="btn" id="btnToggleArchivedDogs">Show archived</button>
    </div>

    <div id="dogsActiveMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="dogsActiveList"></div>

    <div id="dogsArchivedWrap" class="hide" style="margin-top:14px;">
      <div class="muted small" id="dogsArchivedMeta"></div>
      <div id="dogsArchivedList"></div>
    </div>
  </section>

  <!-- DOG PROFILE -->
  <section id="viewDogProfile" class="card hide">
    <h2 id="dogProfileTitle">Dog Profile</h2>

    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>

    <div id="dogArchivedBanner" class="timeline-item hide" style="margin-top:12px;">
      <div><strong id="dogArchivedBannerText">Archived</strong></div>
      <div class="muted small" id="dogArchivedBannerMeta"></div>
    </div>

    <!-- Photo -->
    <div class="timeline-item" style="margin-top:12px;">
      <div><strong>Photo</strong></div>
      <div class="muted small">Tap photo/placeholder to add or update (active). Archived is view-only.</div>

      <div id="dogPhotoTap" style="margin-top:10px; border:1px dashed #bbb; border-radius:12px; padding:12px; text-align:center;">
        <div id="dogPhotoPlaceholder" class="muted small">Tap to add photo</div>
        <img id="dogPhotoImg" alt="Dog photo" style="display:none; max-width:100%; border-radius:12px;" />
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnViewPhoto">View photo</button>
      </div>
    </div>

    <!-- Basics -->
    <div class="timeline-item">
      <div><strong>Basics</strong></div>

      <label class="label">Call name (required)</label>
      <input id="dogCallName" />

      <label class="label">Registered name (optional)</label>
      <input id="dogRegisteredName" />

      <label class="label">Kennel name (optional)</label>
      <input id="dogKennelName" />

      <label class="label">Nicknames (optional)</label>
      <input id="dogNicknames" placeholder="Comma-separated" />

      <label class="label">Breed (default GSP)</label>
      <input id="dogBreed" />

      <div class="grid2">
        <div>
          <label class="label">Sex</label>
          <select id="dogSex">
            <option value="">(unknown)</option>
            <option>Male (intact)</option>
            <option>Male (neutered)</option>
            <option>Female (intact)</option>
            <option>Female (spayed)</option>
          </select>
        </div>
        <div>
          <label class="label">DOB (optional)</label>
          <input id="dogDob" placeholder="YYYY-MM-DD" />
          <div class="muted small" style="margin-top:6px;">
            <label style="display:flex; gap:10px; align-items:center;">
              <input type="checkbox" id="dogDobEstimated" />
              Estimated DOB
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- ID & Health -->
    <div class="timeline-item">
      <div><strong>ID &amp; Health</strong></div>

      <label class="label">Microchip ID (optional)</label>
      <input id="dogMicrochip" />

      <div style="margin-top:10px;">
        <div><strong>Rabies immunization</strong></div>
        <div class="muted small" id="dogRabiesSummary">No rabies record on file</div>
      </div>
    </div>

    <!-- Status -->
    <div class="timeline-item">
      <div><strong>Status</strong></div>

      <label class="label">Status</label>
      <select id="dogStatus">
        <option>Puppy</option>
        <option>Adult</option>
        <option>Retired</option>
        <option>Transferred</option>
        <option>Deceased</option>
      </select>

      <div id="statusNoteWrap" class="hide" style="margin-top:10px;">
        <label class="label">Status note (required for Transferred / Deceased)</label>
        <input id="dogStatusNote" placeholder="Short factual note" />
      </div>

      <div class="muted small" id="dogStatusTimestamps" style="margin-top:8px;"></div>
    </div>

    <!-- Notes -->
    <div class="timeline-item">
      <div><strong>Notes</strong></div>
      <div class="muted small">Notes remain editable even when archived.</div>
      <textarea id="dogNotes" rows="5" style="width:100%; margin-top:8px;"></textarea>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnSaveDog">Save</button>
        <button class="btn" id="btnCancelDog">Cancel</button>
      </div>

      <div class="muted small" id="dogSaveStatus" style="margin-top:10px;"></div>
    </div>
  </section>

  <!-- INVENTORY MENU (unchanged baseline placeholders; kept minimal here) -->
  <section id="viewInventoryMenu" class="card hide">
    <h2>Inventory</h2>
    <div class="row">
      <button class="btn" onclick="__back()">Back</button>
      <button class="btn" onclick="__home()">Home</button>
    </div>
    <div class="goal-grid">
      <button class="btn primary" onclick="__go('InventoryAvailable')">Inventory available</button>
      <button class="btn primary" onclick="__go('InventoryAdd')">Add to inventory</button>
      <button class="btn primary" onclick="__go('InventoryAddStock')">Add stock</button>
      <button class="btn primary" onclick="__go('InventoryReduceStock')">Reduce stock</button>
      <button class="btn primary" onclick="__go('InventoryTransfer')">Transfer inventory</button>
    </div>
  </section>

  <!-- Minimal placeholders to keep your baseline view names intact -->
  <section id="viewInventoryAvailable" class="card hide"><h2>Inventory available</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div><div class="muted small" style="margin-top:10px;">(Inventory baseline is preserved in your locked build.)</div></section>
  <section id="viewInventoryAdd" class="card hide"><h2>Add to inventory</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div><div class="muted small" style="margin-top:10px;">(Inventory baseline is preserved in your locked build.)</div></section>
  <section id="viewInventoryAddStock" class="card hide"><h2>Add stock</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div><div class="muted small" style="margin-top:10px;">(Inventory baseline is preserved in your locked build.)</div></section>
  <section id="viewInventoryReduceStock" class="card hide"><h2>Reduce stock</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div><div class="muted small" style="margin-top:10px;">(Inventory baseline is preserved in your locked build.)</div></section>
  <section id="viewInventoryTransfer" class="card hide"><h2>Transfer inventory</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div><div class="muted small" style="margin-top:10px;">(Inventory baseline is preserved in your locked build.)</div></section>

  <section id="viewFeeding" class="card hide"><h2>Feeding</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewCare" class="card hide"><h2>Care Timeline</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewHelpers" class="card hide"><h2>Helpers</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>
  <section id="viewRecords" class="card hide"><h2>Records</h2><div class="row"><button class="btn" onclick="__back()">Back</button><button class="btn" onclick="__home()">Home</button></div></section>

</main>

<!-- Photo chooser -->
<dialog id="dlgPhotoChoice" class="dlg">
  <form method="dialog" class="dlg-card">
    <div class="dlg-h">
      <h3>Set current photo</h3>
      <button class="info-btn" value="cancel" aria-label="Close">‚úï</button>
    </div>
    <div class="dlg-b">
      <div class="row" style="margin-top:12px;">
        <button type="button" class="btn primary" id="btnTakePhoto">Take photo</button>
        <button type="button" class="btn" id="btnChoosePhoto">Choose from gallery</button>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn" value="cancel">Cancel</button>
    </div>
  </form>
</dialog>

<input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none;" />
<input id="fileGallery" type="file" accept="image/*" style="display:none;" />

<script>
(function(){
  const DOG_KEY="breederPro_dogs_store_v1";
  const nowISO=()=>new Date().toISOString();
  const fmt=(ts)=>{ try{return new Date(ts).toLocaleString();}catch{return "";} };
  const setText=(id,msg)=>{ const el=document.getElementById(id); if(el) el.textContent=msg||""; };

  function loadDogs(){ try{ const raw=localStorage.getItem(DOG_KEY); if(!raw) return {dogs:[]}; const o=JSON.parse(raw); if(!Array.isArray(o.dogs)) o.dogs=[]; return o; }catch{ return {dogs:[]}; } }
  function saveDogs(o){ localStorage.setItem(DOG_KEY, JSON.stringify(o)); }

  let currentDogId=null;

  function addDog(callName){
    const store=loadDogs();
    const dogId="dog_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    store.dogs.push({
      dogId,
      callName,
      registeredName:"",
      kennelName:"",
      nicknames:[],
      breed:"German Shorthaired Pointer",
      sex:"",
      dob:"",
      dobEstimated:false,
      microchip:"",
      rabiesLastDate:null,
      status:"Adult",
      statusChangedAt: nowISO(),
      archived:false,
      archivedAt:null,
      statusNote:"",
      notes:"",
      photoDataUrl:""
    });
    saveDogs(store);
    renderDogs();
  }

  function getDog(id){
    return loadDogs().dogs.find(d=>d.dogId===id) || null;
  }

  function renderDogs(){
    const store=loadDogs();
    const active=store.dogs.filter(d=>!d.archived);
    const archived=store.dogs.filter(d=>d.archived);

    document.getElementById("dogsActiveMeta").textContent=`Active dogs: ${active.length}`;
    document.getElementById("dogsActiveList").innerHTML = active.length ? active.map(d=>`
      <div class="timeline-item">
        <div class="row" style="justify-content:space-between; gap:10px;">
          <div><strong>${d.callName}</strong><div class="muted small">Status: ${d.status}</div></div>
          <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
        </div>
      </div>
    `).join("") : `<div class="muted small">No active dogs yet.</div>`;

    const wrap=document.getElementById("dogsArchivedWrap");
    if(!wrap.classList.contains("hide")){
      document.getElementById("dogsArchivedMeta").textContent=`Archived dogs: ${archived.length}`;
      document.getElementById("dogsArchivedList").innerHTML = archived.length ? archived.map(d=>`
        <div class="timeline-item">
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div><strong>${d.callName}</strong><div class="muted small">Archived ‚Äî ${d.status} ‚Ä¢ ${d.archivedAt?fmt(d.archivedAt):""}</div></div>
            <button class="btn" onclick="__openDog('${d.dogId}')">Open</button>
          </div>
        </div>
      `).join("") : `<div class="muted small">No archived dogs.</div>`;
    }
  }

  function setDogReadOnly(arch){
    const lockIds=[
      "dogCallName","dogRegisteredName","dogKennelName","dogNicknames","dogBreed",
      "dogSex","dogDob","dogMicrochip","dogStatus","dogStatusNote","dogDobEstimated"
    ];
    lockIds.forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.disabled=arch;
    });
    document.getElementById("dogNotes").disabled=false;
    document.getElementById("btnSaveDog").textContent = arch ? "Save notes" : "Save";
  }

  function renderDogProfile(d){
    currentDogId=d.dogId;
    document.getElementById("dogProfileTitle").textContent=d.callName||"Dog Profile";

    const banner=document.getElementById("dogArchivedBanner");
    if(d.archived){
      banner.classList.remove("hide");
      document.getElementById("dogArchivedBannerText").textContent=`Archived ‚Äî ${d.status}`;
      document.getElementById("dogArchivedBannerMeta").textContent=d.archivedAt?`Archived at: ${fmt(d.archivedAt)}`:"";
    } else banner.classList.add("hide");

    const img=document.getElementById("dogPhotoImg");
    const ph=document.getElementById("dogPhotoPlaceholder");
    if(d.photoDataUrl){
      img.src=d.photoDataUrl; img.style.display="block"; ph.style.display="none";
    } else {
      img.src=""; img.style.display="none"; ph.style.display="block";
    }
    document.getElementById("btnViewPhoto").disabled=!d.photoDataUrl;

    document.getElementById("dogCallName").value=d.callName||"";
    document.getElementById("dogRegisteredName").value=d.registeredName||"";
    document.getElementById("dogKennelName").value=d.kennelName||"";
    document.getElementById("dogNicknames").value=(d.nicknames||[]).join(", ");
    document.getElementById("dogBreed").value=d.breed||"German Shorthaired Pointer";
    document.getElementById("dogSex").value=d.sex||"";
    document.getElementById("dogDob").value=d.dob||"";
    document.getElementById("dogDobEstimated").checked=!!d.dobEstimated;
    document.getElementById("dogMicrochip").value=d.microchip||"";
    document.getElementById("dogRabiesSummary").textContent=d.rabiesLastDate?`Last recorded: ${d.rabiesLastDate}`:"No rabies record on file";

    document.getElementById("dogStatus").value=d.status||"Adult";
    document.getElementById("dogStatusNote").value=d.statusNote||"";
    document.getElementById("dogNotes").value=d.notes||"";

    const st=document.getElementById("dogStatus").value;
    const wrap=document.getElementById("statusNoteWrap");
    if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide"); else wrap.classList.add("hide");

    const ts=[];
    if(d.statusChangedAt) ts.push(`Status set: ${fmt(d.statusChangedAt)}`);
    if(d.archivedAt) ts.push(`Archived: ${fmt(d.archivedAt)}`);
    document.getElementById("dogStatusTimestamps").textContent=ts.join(" ‚Ä¢ ");

    setDogReadOnly(!!d.archived);
    setText("dogSaveStatus","");
  }

  window.__openDog=function(id){
    const d=getDog(id);
    if(!d) return;
    __go("DogProfile");
    renderDogProfile(d);
  };

  function saveDogProfile(){
    const store=loadDogs();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;

    // notes always editable
    d.notes=(document.getElementById("dogNotes").value||"").trim();

    if(d.archived){
      saveDogs(store);
      setText("dogSaveStatus","Saved notes.");
      return;
    }

    d.callName=(document.getElementById("dogCallName").value||"").trim()||d.callName;
    d.registeredName=(document.getElementById("dogRegisteredName").value||"").trim();
    d.kennelName=(document.getElementById("dogKennelName").value||"").trim();
    d.nicknames=(document.getElementById("dogNicknames").value||"").split(",").map(s=>s.trim()).filter(Boolean);
    d.breed=(document.getElementById("dogBreed").value||"").trim()||"German Shorthaired Pointer";
    d.sex=document.getElementById("dogSex").value||"";
    d.dob=(document.getElementById("dogDob").value||"").trim();
    d.dobEstimated=!!document.getElementById("dogDobEstimated").checked;
    d.microchip=(document.getElementById("dogMicrochip").value||"").trim();

    const newStatus=document.getElementById("dogStatus").value;
    if(newStatus!==d.status){
      d.status=newStatus;
      d.statusChangedAt=nowISO();
    }

    if(newStatus==="Transferred"||newStatus==="Deceased"){
      const note=(document.getElementById("dogStatusNote").value||"").trim();
      if(!note){
        setText("dogSaveStatus","Status note required.");
        alert("Status note is required for Transferred/Deceased.");
        return;
      }
      d.statusNote=note;
      d.archived=true;
      d.archivedAt=nowISO();
    } else {
      d.archived=false;
      d.archivedAt=null;
      d.statusNote=(document.getElementById("dogStatusNote").value||"").trim();
    }

    saveDogs(store);
    setText("dogSaveStatus","Saved.");
    renderDogs();
    renderDogProfile(d);
  }

  // Photo helpers
  async function compressImageToDataUrl(file){
    const dataUrl=await new Promise((resolve,reject)=>{
      const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
    });
    const img=new Image(); img.src=dataUrl; await new Promise(res=>img.onload=res);
    const maxEdge=900;
    const scale=Math.min(1, maxEdge/Math.max(img.width,img.height));
    const w=Math.max(1, Math.round(img.width*scale));
    const h=Math.max(1, Math.round(img.height*scale));
    const c=document.createElement("canvas"); c.width=w; c.height=h;
    c.getContext("2d").drawImage(img,0,0,w,h);
    return c.toDataURL("image/jpeg",0.78);
  }

  async function setDogPhoto(file){
    const store=loadDogs();
    const d=store.dogs.find(x=>x.dogId===currentDogId);
    if(!d) return;
    if(d.archived) return alert("Archived dogs are view-only.");
    d.photoDataUrl=await compressImageToDataUrl(file);
    saveDogs(store);
    renderDogs();
    renderDogProfile(d);
  }

  // Bind dogs UI
  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("btnAddDog").addEventListener("click", ()=>{
      const name=prompt("Call name (required):");
      if(!name) return;
      addDog(name.trim());
    });

    document.getElementById("btnToggleArchivedDogs").addEventListener("click", ()=>{
      document.getElementById("dogsArchivedWrap").classList.toggle("hide");
      renderDogs();
    });

    document.getElementById("dogStatus").addEventListener("change", ()=>{
      const st=document.getElementById("dogStatus").value;
      const wrap=document.getElementById("statusNoteWrap");
      if(st==="Transferred"||st==="Deceased") wrap.classList.remove("hide"); else wrap.classList.add("hide");
    });

    document.getElementById("btnSaveDog").addEventListener("click", saveDogProfile);
    document.getElementById("btnCancelDog").addEventListener("click", ()=>{ setText("dogSaveStatus",""); __back(); });

    document.getElementById("dogPhotoTap").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(!d) return;
      if(d.archived){
        if(d.photoDataUrl) window.open(d.photoDataUrl,"_blank");
        return;
      }
      document.getElementById("dlgPhotoChoice").showModal();
    });

    document.getElementById("btnViewPhoto").addEventListener("click", ()=>{
      const d=getDog(currentDogId);
      if(d?.photoDataUrl) window.open(d.photoDataUrl,"_blank");
    });

    document.getElementById("btnTakePhoto").addEventListener("click", ()=>document.getElementById("fileCamera").click());
    document.getElementById("btnChoosePhoto").addEventListener("click", ()=>document.getElementById("fileGallery").click());

    document.getElementById("fileCamera").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhoto(f);
      document.getElementById("dlgPhotoChoice").close();
    });

    document.getElementById("fileGallery").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; e.target.value="";
      if(!f) return;
      await setDogPhoto(f);
      document.getElementById("dlgPhotoChoice").close();
    });

    // Talk button
    document.getElementById("btnTalk").addEventListener("click", ()=>alert("Voice may be used at any time."));

    // AfterShow hook
    window.__afterShow = function(view){
      if(view==="Dogs") renderDogs();
      if(view==="DogProfile"){
        const d=getDog(currentDogId);
        if(d) renderDogProfile(d);
      }
    };

    // Initial
    renderDogs();
  });
})();
</script>

</body>
</html>
